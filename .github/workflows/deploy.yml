name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Images"] # 1. build.yml íŒŒì¼ ì´ë¦„ (ìˆ˜ì •ë¨)
    types: [ completed ]
    branches: [ main ]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 2. 'build' ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µ(success)í–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.workflow_run.conclusion == 'success'

    steps:
#       rsyncë‚˜ scp**ë¥¼ ì‚¬ìš©í•´ GitHub Actions ê°€ìƒ ë¨¸ì‹ ì— ìˆëŠ” íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì§ì ‘ ë³µì‚¬í•˜ëŠ” ë°©ì‹ì¼ ë•Œ ì‚¬ìš©
#      - name: Check out (for metadata only)
#        uses: actions/checkout@v4

      - name: SSH deploy to EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            # ---- Docker/Compose ì¤€ë¹„ ----
            command -v docker >/dev/null 2>&1 || curl -fsSL https://get.docker.com | sudo sh
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update -y && sudo apt-get install -y docker-compose-plugin
            fi
            command -v git >/dev/null 2>&1 || sudo apt-get install -y git

            # ---- ì•± ë””ë ‰í† ë¦¬ & ì½”ë“œ ----
            APP_DIR=/srv/gomoku
            REPO_URL="${{ secrets.REPO_URL }}"
            sudo mkdir -p "$APP_DIR"
            sudo chown ubuntu:ubuntu "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "$REPO_URL" "$APP_DIR"
            else
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/main
            fi

            cd "$APP_DIR"

            # ---- í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ----
            mkdir -p envs
            cat > envs/.env.prod << 'EOF'
            ${{ secrets.ENV_PROD }}
            EOF

            # ---- SSL ì¸ì¦ì„œ ì²´í¬ ë° ë°œê¸‰ ----
            DOMAIN="${{ secrets.DOMAIN }}"
            SSL_EMAIL="${{ secrets.SSL_EMAIL }}"
            CERT_PATH="$APP_DIR/certbot/conf/live/$DOMAIN/fullchain.pem"

            # ìµœì´ˆ ë°°í¬ ì‹œ HTTPë¡œ ì‹œì‘ í›„ SSL ì¸ì¦ì„œ ë°œê¸‰
            if [ ! -f "$CERT_PATH" ]; then
              echo "ğŸ” SSL ì¸ì¦ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ë°œê¸‰ì„ ì‹œì‘í•©ë‹ˆë‹¤..."

              # HTTPë§Œìœ¼ë¡œ ë¨¼ì € ì‹œì‘ (SSL ì¸ì¦ì„œ ê²€ì¦ìš©)
              docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --pull=always

              # ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
              sleep 10

              # Let's Encrypt SSL ì¸ì¦ì„œ ë°œê¸‰
              echo "ğŸ“œ Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ ì¤‘..."
              docker compose run --rm certbot certonly --webroot \
                --webroot-path=/var/www/certbot \
                -d "$DOMAIN" \
                -d "www.$DOMAIN" \
                --email "$SSL_EMAIL" \
                --agree-tos \
                --no-eff-email \
                --non-interactive

              # Nginx ì„¤ì •ì„ HTTPS ë²„ì „ìœ¼ë¡œ êµì²´
              echo "ğŸ”’ HTTPS ì„¤ì •ìœ¼ë¡œ ì „í™˜ ì¤‘..."
              docker compose exec -T nginx sh -c "
                sed 's/DOMAIN_PLACEHOLDER/$DOMAIN/g' /etc/nginx/conf.d/nginx-ssl.conf.template > /etc/nginx/conf.d/default.conf &&
                nginx -t &&
                nginx -s reload
              "

              echo "âœ… SSL ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ ë° HTTPS í™œì„±í™”!"
            else
              echo "âœ… SSL ì¸ì¦ì„œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi

            # ---- ì¼ë°˜ ë°°í¬ (ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸) ----
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --pull=always

            # ---- ìƒíƒœ/ë¡œê·¸ ì²´í¬ ----
            docker compose ps
            docker compose logs -n 80 web nginx

            # ---- ì‚¬ìš© ì•ˆ í•˜ëŠ” ì´ë¯¸ì§€/ë ˆì´ì–´ ì •ë¦¬ ----
            docker system prune -f