{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>오목조목 로비 – 오목조목</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="온라인 실시간 오목 게임 - 친구와 함께 플레이하세요!" />
  <meta name="theme-color" content="#3e2a1f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="오목조목" />

  <!-- Manifest -->
  <link rel="manifest" href="{% static 'manifest.json' %}" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'icons/icon-192x192.png' %}" />
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'icons/icon-512x512.png' %}" />
  <link rel="apple-touch-icon" href="{% static 'icons/icon-192x192.png' %}" />


  <style>
    :root {
      --wood: #d4b781;
      --line: #7b5c3a;
      --border: #3e2a1f;
      --card: #fff9ee;
      --bg: linear-gradient(var(--line) 1px, transparent 1px) 0 0 / 36px 36px,
            linear-gradient(90deg, var(--line) 1px, transparent 1px) 0 0 / 36px 36px,
            var(--wood);
      --text: #333;
      --text-secondary: #666;
      --card-border: var(--line);
      --input-bg: #fffdf7;
      --shadow: rgba(0, 0, 0, 0.15);

      /* 티어 색상 */
      --tier-5급: #6b7280;
      --tier-4급: #3b82f6;
      --tier-3급: #06b6d4;
      --tier-2급: #10b981;
      --tier-1급: #22c55e;
      --tier-1단: #84cc16;
      --tier-2단: #eab308;
      --tier-3단: #f59e0b;
      --tier-낭인: #8b5cf6;
      --tier-달인: #a855f7;
      --tier-명인: #ec4899;
      --tier-지존: #f43f5e;
      --tier-패왕: #ef4444;
      --tier-투신: #dc2626;
      --tier-무신: #b91c1c;
    }

    /* 다크모드 */
    [data-theme="dark"] {
      --wood: #1a1a2e;
      --line: #2d2d44;
      --border: #4ade80;
      --card: #16213e;
      --bg: linear-gradient(#2d2d44 1px, transparent 1px) 0 0 / 36px 36px,
            linear-gradient(90deg, #2d2d44 1px, transparent 1px) 0 0 / 36px 36px,
            #0f0f1a;
      --text: #e5e7eb;
      --text-secondary: #9ca3af;
      --card-border: #2d3748;
      --input-bg: #1e293b;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    /* 다크모드 컴포넌트 스타일 */
    [data-theme="dark"] .container {
      background: rgba(22, 33, 62, 0.95);
      border-color: #2d3748;
    }

    [data-theme="dark"] .header h1 {
      color: #4ade80;
    }

    [data-theme="dark"] .header .user-info {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.05));
      border-color: rgba(74, 222, 128, 0.3);
    }

    [data-theme="dark"] .header .user-info .my-nickname {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    [data-theme="dark"] .btn {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .online-users-section,
    [data-theme="dark"] .rooms-section {
      background: #1e293b;
      border-color: #2d3748;
    }

    [data-theme="dark"] .online-users-header h3,
    [data-theme="dark"] .rooms-header h2 {
      color: #e5e7eb;
    }

    [data-theme="dark"] .user-badge {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-color: #374151;
    }

    [data-theme="dark"] .user-badge:hover {
      border-color: #4ade80;
    }

    [data-theme="dark"] .user-badge .nickname-link {
      background: linear-gradient(135deg, #e5e7eb, #9ca3af);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    [data-theme="dark"] .user-badge.waiting {
      background: linear-gradient(135deg, rgba(255, 140, 66, 0.1), #0f172a);
    }

    [data-theme="dark"] .user-badge.playing {
      background: linear-gradient(135deg, rgba(240, 180, 41, 0.1), #0f172a);
    }

    [data-theme="dark"] .user-badge.matchmaking {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), #0f172a);
    }

    [data-theme="dark"] .room-card {
      background: #1e293b;
      border-color: #374151;
    }

    [data-theme="dark"] .room-card:hover {
      border-color: #4ade80;
      box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2);
    }

    [data-theme="dark"] .room-title {
      color: #e5e7eb;
    }

    [data-theme="dark"] .room-info {
      color: #9ca3af;
    }

    [data-theme="dark"] .chat-container {
      background: #16213e;
      border-color: #2d3748;
    }

    [data-theme="dark"] .chat-header {
      background: #1e293b;
    }

    [data-theme="dark"] .chat-messages {
      background: #0f172a;
    }

    [data-theme="dark"] .chat-message .text {
      background: #1e293b;
      border-color: #374151;
      color: #e5e7eb;
    }

    [data-theme="dark"] .chat-message.mine .text {
      background: rgba(74, 222, 128, 0.15);
      border-color: #4ade80;
    }

    [data-theme="dark"] .chat-message .sender {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.05));
      border-color: rgba(74, 222, 128, 0.2);
    }

    [data-theme="dark"] .chat-input {
      background: #1e293b;
      border-color: #374151;
      color: #e5e7eb;
    }

    [data-theme="dark"] .modal-content {
      background: #16213e;
      border-color: #2d3748;
    }

    [data-theme="dark"] .modal-content h2 {
      color: #e5e7eb;
    }

    [data-theme="dark"] .ranking-table th {
      background: #1e293b;
      color: #e5e7eb;
    }

    [data-theme="dark"] .ranking-table tbody tr {
      border-color: #374151;
    }

    [data-theme="dark"] .ranking-table tbody tr:hover {
      background: rgba(74, 222, 128, 0.1);
    }

    [data-theme="dark"] .ranking-table td {
      color: #e5e7eb;
    }

    [data-theme="dark"] .ranking-table td.nickname .nickname-link {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.05));
      border-color: rgba(74, 222, 128, 0.2);
      color: #e5e7eb;
    }

    [data-theme="dark"] .nickname-link {
      color: #e5e7eb;
    }

    [data-theme="dark"] .active-game-banner {
      background: linear-gradient(135deg, #065f46, #047857);
    }

    [data-theme="dark"] .empty-rooms,
    [data-theme="dark"] .empty-ranking {
      color: #9ca3af;
    }

    [data-theme="dark"] .tier-list-content {
      background: #1e293b;
    }

    [data-theme="dark"] .tier-list-content .tier-group h4 {
      color: #e5e7eb;
    }

    [data-theme="dark"] .tier-list-content .tier-item {
      background: #0f172a;
      border-color: #374151;
    }

    [data-theme="dark"] .tier-list-content .tier-item .rp-range {
      color: #9ca3af;
    }

    /* 다크모드 토글 버튼 */
    .theme-toggle {
      background: linear-gradient(135deg, #374151, #1f2937);
      color: #fff;
    }

    [data-theme="dark"] .theme-toggle {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1f2937;
    }

    /* 롤 스타일 티어 뱃지 */
    .tier-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 800;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.3),
        inset 0 -1px 0 rgba(0,0,0,0.2),
        0 2px 4px rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.1);
      letter-spacing: 0.5px;
    }

    .tier-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
      border-radius: 5px 5px 0 0;
      pointer-events: none;
    }

    .tier-badge .tier-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
    }

    /* 급 티어 (브론즈~실버 느낌) */
    .tier-badge.tier-5급 {
      background: linear-gradient(135deg, #8b7355 0%, #6b5344 50%, #8b7355 100%);
      color: #f5e6d3;
      border-color: #5a4535;
    }
    .tier-badge.tier-4급 {
      background: linear-gradient(135deg, #9a8a7a 0%, #7a6a5a 50%, #9a8a7a 100%);
      color: #fff5eb;
      border-color: #6a5a4a;
    }
    .tier-badge.tier-3급 {
      background: linear-gradient(135deg, #a8a8a8 0%, #888888 50%, #a8a8a8 100%);
      color: #ffffff;
      border-color: #707070;
    }
    .tier-badge.tier-2급 {
      background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 50%, #c0c0c0 100%);
      color: #ffffff;
      border-color: #909090;
    }
    .tier-badge.tier-1급 {
      background: linear-gradient(135deg, #d4d4d4 0%, #b8b8b8 50%, #d4d4d4 100%);
      color: #ffffff;
      border-color: #a0a0a0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }

    /* 단 티어 (골드 느낌) */
    .tier-badge.tier-1단 {
      background: linear-gradient(135deg, #c9a227 0%, #a68523 50%, #c9a227 100%);
      color: #fff8dc;
      border-color: #8b7500;
    }
    .tier-badge.tier-2단 {
      background: linear-gradient(135deg, #daa520 0%, #b8860b 50%, #daa520 100%);
      color: #fffacd;
      border-color: #996515;
    }
    .tier-badge.tier-3단 {
      background: linear-gradient(135deg, #ffd700 0%, #daa520 50%, #ffd700 100%);
      color: #ffffff;
      border-color: #b8860b;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* 고급 티어 (플래티넘~다이아 느낌) */
    .tier-badge.tier-낭인 {
      background: linear-gradient(135deg, #4fc3c7 0%, #26a69a 50%, #4fc3c7 100%);
      color: #e0ffff;
      border-color: #1a8a7e;
    }
    .tier-badge.tier-달인 {
      background: linear-gradient(135deg, #00bcd4 0%, #0097a7 50%, #00bcd4 100%);
      color: #e0ffff;
      border-color: #007687;
    }
    .tier-badge.tier-명인 {
      background: linear-gradient(135deg, #7c4dff 0%, #651fff 50%, #7c4dff 100%);
      color: #e8e0ff;
      border-color: #5000e0;
    }

    /* 최상위 티어 (마스터~챌린저 느낌) */
    .tier-badge.tier-지존 {
      background: linear-gradient(135deg, #e040fb 0%, #aa00ff 50%, #e040fb 100%);
      color: #ffe0ff;
      border-color: #8800cc;
    }
    .tier-badge.tier-패왕 {
      background: linear-gradient(135deg, #ff5252 0%, #d32f2f 50%, #ff5252 100%);
      color: #ffe0e0;
      border-color: #b71c1c;
    }
    .tier-badge.tier-투신 {
      background: linear-gradient(135deg, #ff1744 0%, #c51162 50%, #ff1744 100%);
      color: #ffffff;
      border-color: #ab003c;
      animation: tier-glow-red 2s ease-in-out infinite;
    }
    .tier-badge.tier-무신 {
      background: linear-gradient(135deg, #ffd54f 0%, #ffab00 25%, #ff6f00 50%, #ffab00 75%, #ffd54f 100%);
      background-size: 200% 200%;
      color: #ffffff;
      border: 2px solid #ffd700;
      text-shadow: 0 0 10px rgba(255,215,0,0.8), 0 1px 2px rgba(0,0,0,0.5);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.4),
        inset 0 -1px 0 rgba(0,0,0,0.2),
        0 0 15px rgba(255,215,0,0.5),
        0 2px 4px rgba(0,0,0,0.3);
      animation: tier-shine 3s linear infinite;
    }

    /* 배치중 */
    .tier-badge.tier-placement {
      background: linear-gradient(135deg, #607d8b 0%, #455a64 50%, #607d8b 100%);
      color: #eceff1;
      border-color: #37474f;
    }

    @keyframes tier-shine {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes tier-glow-red {
      0%, 100% { box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2), 0 0 8px rgba(255,23,68,0.4); }
      50% { box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2), 0 0 15px rgba(255,23,68,0.7); }
    }

    /* 티어 목록 모달 스타일 */
    .tier-list-container {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }
    .tier-list-container::-webkit-scrollbar {
      width: 6px;
    }
    .tier-list-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .tier-list-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    .tier-group {
      margin-bottom: 16px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }
    .tier-group-title {
      padding: 8px 12px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .tier-group-legendary .tier-group-title {
      background: linear-gradient(135deg, #ff6f00, #ff8f00);
      color: white;
    }
    .tier-group-master .tier-group-title {
      background: linear-gradient(135deg, #7c4dff, #aa00ff);
      color: white;
    }
    .tier-group-gold .tier-group-title {
      background: linear-gradient(135deg, #ffc107, #ff8f00);
      color: white;
    }
    .tier-group-silver .tier-group-title {
      background: linear-gradient(135deg, #90a4ae, #78909c);
      color: white;
    }
    .tier-group-bronze .tier-group-title {
      background: linear-gradient(135deg, #8d6e63, #6d4c41);
      color: white;
    }
    .tier-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border-top: 1px solid #f0f0f0;
    }
    .tier-item:first-of-type {
      border-top: none;
    }
    .tier-rp {
      font-size: 13px;
      color: #666;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      background: var(--card);
      padding: 20px 24px;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 24px;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      color: var(--border);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-stones {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .stone {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: inline-block;
      position: relative;
      box-shadow:
        0 3px 6px rgba(0, 0, 0, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .stone-black {
      background: radial-gradient(circle at 35% 35%, #555, #1a1a1a 50%, #000 100%);
      border: 1px solid #000;
    }

    .stone-black::after {
      content: "";
      position: absolute;
      top: 4px;
      left: 6px;
      width: 8px;
      height: 5px;
      background: radial-gradient(ellipse, rgba(255,255,255,0.4), transparent);
      border-radius: 50%;
      transform: rotate(-30deg);
    }

    .stone-white {
      background: radial-gradient(circle at 35% 35%, #fff, #e8e8e8 40%, #ccc 100%);
      border: 1px solid #aaa;
    }

    .stone-white::after {
      content: "";
      position: absolute;
      top: 4px;
      left: 6px;
      width: 8px;
      height: 5px;
      background: radial-gradient(ellipse, rgba(255,255,255,0.9), transparent);
      border-radius: 50%;
      transform: rotate(-30deg);
    }

    .header .user-info {
      font-weight: 700;
      margin-right: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 80px;
      background: linear-gradient(135deg, rgba(74, 124, 89, 0.1), rgba(90, 74, 58, 0.1));
      border-radius: 20px;
      border: 1px solid rgba(74, 124, 89, 0.3);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .header .user-info .my-nickname {
      background: linear-gradient(135deg, #4a7c59, #2d5a3d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 15px;
      letter-spacing: 0.5px;
    }

    .btn {
      display: inline-block;
      padding: 8px 12px;
      background: var(--border);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box;
      line-height: normal;
      vertical-align: middle;
      font-family: inherit;
      font-size: 13px;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn:disabled:hover {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .rooms-section {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .rooms-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--line);
    }

    .rooms-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--border);
    }

    .room-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .room-card {
      display: block;
      padding: 16px 20px;
      background: white;
      border: 2px solid var(--line);
      border-radius: 10px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
      cursor: pointer;
    }

    .room-card:hover {
      border-color: var(--border);
      transform: translateX(4px);
      box-shadow: -4px 4px 0 var(--line);
    }

    .room-card .room-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--border);
      margin-bottom: 8px;
    }

    .room-card .room-info {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 16px;
    }

    .empty-state::before {
      content: "●○";
      display: block;
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .logout-btn {
      background: #999;
      padding: 8px 16px;
      font-size: 14px;
    }

    .top-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: nowrap;
      justify-content: center;
      width: 100%;
    }

    .top-actions .btn {
      font-size: 12px !important;
      padding: 6px 10px !important;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    /* 로그아웃 + 다크모드 묶음 */
    .action-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex: 1;
    }

    .action-group .btn {
      flex: 1;
    }

    /* 타이틀 행 (웹에서는 일반 flex) */
    .header-title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    /* 웹: 유저 정보 행 - 타이틀 옆 인라인 */
    .header-user-row {
      display: inline-flex;
      align-items: center;
      margin-left: 4px;
      gap: 8px;
    }
    .admin-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-radius: 10px;
      text-decoration: none;
      line-height: 1.4;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .admin-badge:hover {
      background: linear-gradient(135deg, #f87171, #ef4444);
    }
    [data-theme="dark"] .admin-badge {
      background: linear-gradient(135deg, #f87171, #ef4444);
    }
    [data-theme="dark"] .admin-badge:hover {
      background: linear-gradient(135deg, #fca5a5, #f87171);
    }

    /* 웹: 모바일 로그아웃 숨김 */
    .mobile-logout {
      display: none !important;
    }

    /* 모바일 다크모드 버튼 - 웹에서 숨김 */
    .mobile-theme-toggle {
      display: none !important;
    }

    /* 접속자 목록 스타일 */
    .online-users-section {
      background: var(--card);
      padding: 20px 24px;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 24px;
    }

    .online-users-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .online-users-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--border);
      font-weight: 700;
    }

    .online-count {
      background: #4a7c59;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
    }

    .users-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #fff, #f8f8f8);
      border: 1px solid #e0e0e0;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      color: #333;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
    }

    .user-badge > * {
      display: inline-flex;
      align-items: center;
    }

    .user-badge .tier-badge {
      margin-right: 2px;
    }

    .user-profile-img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #e0e0e0;
    }

    [data-theme="dark"] .user-profile-img {
      border-color: #4b5563;
    }

    .user-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #4a7c59;
    }

    .user-badge::before {
      content: "";
      width: 8px;
      height: 8px;
      background: #4a7c59;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(74, 124, 89, 0.5);
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 6px rgba(74, 124, 89, 0.5); }
      50% { box-shadow: 0 0 12px rgba(74, 124, 89, 0.8); }
    }

    @keyframes pulse-orange {
      0%, 100% { box-shadow: 0 0 6px rgba(255, 140, 66, 0.5); }
      50% { box-shadow: 0 0 12px rgba(255, 140, 66, 0.8); }
    }

    @keyframes pulse-yellow {
      0%, 100% { box-shadow: 0 0 6px rgba(240, 180, 41, 0.5); }
      50% { box-shadow: 0 0 12px rgba(240, 180, 41, 0.8); }
    }

    .user-badge .nickname-link {
      font-weight: 600;
      background: linear-gradient(135deg, #333, #555);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-badge .nickname-link:hover {
      background: linear-gradient(135deg, #4a7c59, #3a6c49);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transform: none;
      box-shadow: none;
    }

    /* 게임룸 대기중인 사용자 스타일 (주황색) */
    .user-badge.waiting::before {
      background: #ff8c42;
      animation: pulse-orange 2s infinite;
    }

    .user-badge.waiting {
      border-color: #ff8c42;
      background: linear-gradient(135deg, #fff5ed, #fff);
    }

    .user-badge.waiting .nickname-link {
      background: linear-gradient(135deg, #e67e22, #d35400);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* 게임 중인 사용자 스타일 (노란색) */
    .user-badge.playing::before {
      background: #f0b429;
      animation: pulse-yellow 2s infinite;
    }

    .user-badge.playing {
      border-color: #f0b429;
      background: linear-gradient(135deg, #fffbf0, #fff);
    }

    .user-badge.playing .nickname-link {
      background: linear-gradient(135deg, #f39c12, #d68910);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* RP매칭 중인 사용자 스타일 (보라색) */
    .user-badge.matchmaking::before {
      background: #9b59b6;
      animation: pulse-purple 2s infinite;
    }

    .user-badge.matchmaking {
      border-color: #9b59b6;
      background: linear-gradient(135deg, #f5eef8, #fff);
    }

    .user-badge.matchmaking .nickname-link {
      background: linear-gradient(135deg, #8e44ad, #7d3c98);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* AI 대전 중인 사용자 스타일 (청록색) */
    .user-badge.ai_playing::before {
      background: #06b6d4;
      animation: pulse-cyan 2s infinite;
    }

    .user-badge.ai_playing {
      border-color: #06b6d4;
      background: linear-gradient(135deg, #ecfeff, #fff);
    }

    .user-badge.ai_playing .nickname-link {
      background: linear-gradient(135deg, #0891b2, #0e7490);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    [data-theme="dark"] .user-badge.ai_playing {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), #0f172a);
    }

    @keyframes pulse-cyan {
      0%, 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(6, 182, 212, 0); }
    }

    /* 유저 드롭다운 메뉴 */
    .user-dropdown {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 4px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 1000;
      min-width: 120px;
      overflow: hidden;
      display: none;
    }

    .user-dropdown.active {
      display: block;
    }

    .user-dropdown-item {
      display: block;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      text-align: left;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s;
    }

    .user-dropdown-item:hover {
      background: rgba(74, 124, 89, 0.1);
    }

    .user-dropdown-item:not(:last-child) {
      border-bottom: 1px solid var(--line);
    }

    [data-theme="dark"] .user-dropdown {
      background: #1e293b;
      border-color: #374151;
    }

    [data-theme="dark"] .user-dropdown-item:hover {
      background: rgba(74, 222, 128, 0.1);
    }

    .user-badge {
      position: relative;
    }

    @keyframes pulse-purple {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    /* 진행 중인 게임 배너 */
    .active-game-banner {
      background: linear-gradient(135deg, #4a7c59 0%, #5a8c69 100%);
      padding: 20px 24px;
      border-radius: 12px;
      border: 2px solid #3e6b4f;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      animation: pulse 2s ease-in-out infinite;
    }

    .banner-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .banner-icon {
      font-size: 32px;
      animation: bounce 1s ease-in-out infinite;
    }

    .banner-text strong {
      display: block;
      color: white;
      font-size: 18px;
      margin-bottom: 4px;
    }

    .banner-text p {
      margin: 0;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
    }

    .btn-rejoin {
      background: white;
      color: #4a7c59;
      font-weight: 700;
      padding: 12px 24px;
      white-space: nowrap;
    }

    .btn-rejoin:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3); }
      50% { box-shadow: 0 4px 20px rgba(74, 124, 89, 0.5); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* 토스트 알림 스타일 */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      min-width: 300px;
    }

    .toast.success {
      border-left-color: #4a7c59;
      background: linear-gradient(135deg, #f0f9f4 0%, #ffffff 100%);
    }

    .toast.error {
      border-left-color: #c53030;
      background: linear-gradient(135deg, #fef5f5 0%, #ffffff 100%);
    }

    .toast.info {
      border-left-color: #4a7c89;
      background: linear-gradient(135deg, #f0f7f9 0%, #ffffff 100%);
    }

    .toast.invite {
      border-left-color: #b8860b;
      background: linear-gradient(135deg, #fdf8ef 0%, #ffffff 100%);
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .toast.invite .toast-top {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .toast.invite .invite-buttons {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .toast.invite .invite-buttons button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toast.invite .btn-invite-accept {
      background: #4a7c59;
      color: white;
    }

    .toast.invite .btn-invite-accept:hover {
      background: #3d6b4a;
    }

    .toast.invite .btn-invite-decline {
      background: #e2e8f0;
      color: #4a5568;
    }

    .toast.invite .btn-invite-decline:hover {
      background: #cbd5e0;
    }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: #4a7c59;
    }

    .toast.error .toast-icon {
      color: #c53030;
    }

    .toast.info .toast-icon {
      color: #4a7c89;
    }

    .toast-content {
      flex: 1;
    }

    .toast-message {
      color: #333;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
    }

    .toast-close {
      background: none;
      border: none;
      color: #999;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .toast-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #333;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.slide-out {
      animation: slideOut 0.3s ease-out forwards;
    }

    .ws-status {
      font-size: 12px;
      color: #999;
    }

    .ws-status.connected { color: #4a7c59; }
    .ws-status.disconnected { color: #c44; }

    /* 랭킹판 스타일 */
    .ranking-section {
      background: var(--card);
      padding: 20px 24px;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 24px;
    }

    .ranking-header {
      margin-bottom: 16px;
    }

    .ranking-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--border);
      font-weight: 700;
    }

    .ranking-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--line);
    }

    .ranking-tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #666;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ranking-tab:hover {
      color: var(--border);
      background: rgba(123, 92, 58, 0.05);
    }

    .ranking-tab.active {
      color: var(--border);
      border-bottom-color: var(--border);
    }

    .ranking-content {
      display: block;
    }

    .ranking-content.hidden {
      display: none;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .ranking-table thead {
      background: var(--line);
      color: white;
    }

    .ranking-table th {
      padding: 10px 8px;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
    }

    .ranking-table tbody tr {
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }

    .ranking-table tbody tr:hover {
      background: rgba(212, 183, 129, 0.1);
    }

    .ranking-table tbody tr:last-child {
      border-bottom: none;
    }

    .ranking-table td {
      padding: 12px 8px;
      text-align: center;
    }

    .ranking-table td.rank {
      font-weight: 700;
      color: var(--border);
      font-size: 15px;
    }

    .ranking-table td.nickname {
      font-weight: 600;
      color: #333;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ranking-table td.nickname .nickname-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(74, 124, 89, 0.08), rgba(90, 74, 58, 0.05));
      border: 1px solid rgba(74, 124, 89, 0.15);
      transition: all 0.2s ease;
    }

    .ranking-table td.nickname .nickname-link:hover {
      background: linear-gradient(135deg, #4a7c59, #3a6c49);
      border-color: #3a6c49;
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(74, 124, 89, 0.3);
    }

    /* 1~3등 특별 스타일 */
    .ranking-table tbody tr:nth-child(1) td.nickname .nickname-link {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 193, 7, 0.1));
      border-color: rgba(255, 193, 7, 0.4);
    }

    .ranking-table tbody tr:nth-child(2) td.nickname .nickname-link {
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(169, 169, 169, 0.1));
      border-color: rgba(192, 192, 192, 0.5);
    }

    .ranking-table tbody tr:nth-child(3) td.nickname .nickname-link {
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.15), rgba(184, 115, 51, 0.1));
      border-color: rgba(205, 127, 50, 0.4);
    }

    .ranking-table td.winrate {
      font-weight: 700;
      color: #4a7c59;
    }

    .ranking-table td.total-games {
      font-weight: 700;
      color: #5a7c9a;
    }

    /* 순위별 메달 색상 */
    .ranking-table tbody tr:nth-child(1) td.rank {
      color: #FFD700; /* 금메달 */
    }

    .ranking-table tbody tr:nth-child(2) td.rank {
      color: #C0C0C0; /* 은메달 */
    }

    .ranking-table tbody tr:nth-child(3) td.rank {
      color: #CD7F32; /* 동메달 */
    }

    .empty-ranking {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 14px;
    }

    /* 3열 랭킹 테이블 (RP, 판수) - 컴팩트 레이아웃 */
    .ranking-table-compact {
      table-layout: fixed;
    }

    .ranking-table-compact th:first-child,
    .ranking-table-compact td:first-child {
      width: 12%;
    }

    .ranking-table-compact th:nth-child(2),
    .ranking-table-compact td:nth-child(2) {
      width: 63%;
    }

    .ranking-table-compact th:last-child,
    .ranking-table-compact td:last-child {
      width: 25%;
    }

    /* 닉네임 링크 스타일 */
    .nickname-link {
      text-decoration: none;
      color: #333;
      position: relative;
      cursor: pointer;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s ease;
      background: linear-gradient(135deg, transparent, transparent);
    }

    .nickname-link:hover {
      color: #fff;
      background: linear-gradient(135deg, #4a7c59, #3a6c49);
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(74, 124, 89, 0.3);
    }

    /* 툴팁 스타일 */
    .nickname-link[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white !important;
      -webkit-text-fill-color: white !important;
      background-clip: padding-box !important;
      -webkit-background-clip: padding-box !important;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
      margin-bottom: 8px;
    }

    .nickname-link[data-tooltip]:hover::after {
      opacity: 1;
    }

    /* 툴팁 화살표 */
    .nickname-link[data-tooltip]::before {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
      margin-bottom: 3px;
    }

    .nickname-link[data-tooltip]:hover::before {
      opacity: 1;
    }

    /* 제목 입력 모달 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      padding: 32px;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .modal-content h2 {
      margin: 0 0 20px 0;
      font-size: 20px;
      color: var(--border);
      text-align: center;
    }

    .modal-content input[type="text"],
    .modal-content input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--line);
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      background: white;
      margin-bottom: 16px;
    }

    .modal-content input[type="text"]:focus,
    .modal-content input[type="password"]:focus {
      outline: none;
      border-color: var(--border);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-buttons .btn {
      flex: 1;
      margin: 0;
    }

    .modal-buttons .btn-cancel {
      background: #999;
    }

    /* 설정 모달 */
    .settings-group {
      background: var(--input-bg);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 12px;
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
    }
    .settings-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #ccc;
      border-radius: 24px;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: #4a7c59;
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }
    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .volume-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100px;
      height: 6px;
      border-radius: 3px;
      background: var(--line);
      outline: none;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4a7c59;
      cursor: pointer;
    }
    .volume-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4a7c59;
      cursor: pointer;
      border: none;
    }
    .volume-value {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 32px;
      text-align: right;
    }

    /* 채팅창 */
    .chat-container {
      position: fixed;
      bottom: 20px;
      left: 10px;
      width: 320px;
      height: 400px;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .chat-container.hidden {
      transform: translateY(calc(100% + 30px));
    }

    .chat-toggle-btn {
      position: fixed;
      bottom: 20px;
      left: 10px;
      width: 60px;
      height: 60px;
      background: var(--border);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .chat-toggle-btn:active {
      transform: scale(0.95);
    }

    .chat-close-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .chat-header {
      padding: 12px 16px;
      background: var(--border);
      color: white;
      font-weight: 700;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-message {
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: flex-start;
    }

    .chat-profile-img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid var(--line);
    }

    .chat-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .chat-message .sender {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(90, 74, 58, 0.1), rgba(196, 155, 84, 0.15));
      border: 1px solid rgba(196, 155, 84, 0.3);
    }

    .chat-message .sender .chat-nickname {
      background: linear-gradient(135deg, #5a4a3a, #3a2a1a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chat-message .text {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-size: 14px;
      word-wrap: break-word;
      max-width: 240px;
      word-break: break-word;
    }

    .chat-message.mine {
      flex-direction: row-reverse;
    }

    .chat-message.mine .chat-content {
      align-items: flex-end;
    }

    .chat-message.mine .sender {
      background: linear-gradient(135deg, rgba(74, 124, 89, 0.15), rgba(58, 108, 73, 0.1));
      border-color: rgba(74, 124, 89, 0.3);
    }

    .chat-message.mine .sender .chat-nickname {
      background: linear-gradient(135deg, #4a7c59, #2d5a3d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chat-message.mine .text {
      background: #e8f5e9;
      border-color: #4a7c59;
    }

    .chat-input-container {
      padding: 12px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid var(--line);
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    .chat-input:focus {
      border-color: var(--border);
    }

    .chat-send-btn {
      padding: 8px 16px;
      background: var(--border);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-send-btn:hover {
      background: #2e1a0f;
    }

    .chat-send-btn:active {
      transform: scale(0.95);
    }

    /* ===== 모바일 반응형 ===== */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
      }

      /* 모바일: 타이틀 행 (타이틀 + 다크모드) */
      .header-title-row {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        gap: 6px;
        width: 100%;
      }

      .header h1 {
        font-size: 18px;
        margin: 0;
        white-space: nowrap;
      }

      /* 모바일: 다크모드 버튼 타이틀 옆에 표시 */
      .mobile-theme-toggle {
        display: flex !important;
        padding: 5px 10px !important;
        font-size: 11px !important;
        flex-shrink: 0;
      }

      .header-user-row {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      .header-user-row .user-info {
        flex: 1;
        text-align: center;
        font-size: 14px;
        justify-content: center;
      }

      .mobile-logout {
        display: flex !important;
        font-size: 11px !important;
        padding: 5px 10px !important;
        flex-shrink: 0;
      }

      /* 그리드 내 로그아웃 숨김 (모바일) */
      .action-group .logout-btn {
        display: none !important;
      }

      /* 웹용 action-group 숨김 */
      .action-group .theme-toggle {
        display: none !important;
      }

      .stone {
        width: 20px;
        height: 20px;
      }

      .top-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      .user-info {
        font-size: 13px;
        font-weight: 700;
        padding: 5px 10px;
      }

      .top-actions .btn {
        text-align: center;
        white-space: nowrap;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px !important;
        padding: 6px 6px !important;
      }

      /* 로그아웃 버튼도 다른 버튼과 같은 크기 */
      .top-actions .logout-btn {
        grid-column: auto;
        min-height: 36px;
      }

      .action-group {
        display: contents;
      }

      .online-users-section {
        padding: 16px;
        margin-bottom: 16px;
      }

      .online-users-header h3 {
        font-size: 14px;
      }

      .online-count {
        font-size: 12px;
        padding: 3px 10px;
      }

      .user-badge {
        padding: 6px 12px;
        font-size: 13px;
        gap: 6px;
      }

      .user-badge::before {
        width: 6px;
        height: 6px;
      }

      /* 모바일 진행 중인 게임 배너 */
      .active-game-banner {
        flex-direction: column;
        align-items: stretch;
        padding: 16px;
      }

      .banner-content {
        gap: 12px;
      }

      .banner-icon {
        font-size: 24px;
      }

      .banner-text strong {
        font-size: 16px;
      }

      .btn-rejoin {
        width: 100%;
        text-align: center;
      }

      .rooms-section {
        padding: 16px;
      }

      .rooms-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .rooms-header h2 {
        font-size: 18px;
      }

      .rooms-header .btn {
        align-self: stretch;
        text-align: center;
      }

      .room-card {
        padding: 14px 16px;
      }

      .room-card .room-title {
        font-size: 16px;
      }

      .room-card .room-info {
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
      }

      .room-card .room-info span:nth-child(2) {
        display: none; /* 구분자 "|" 숨김 */
      }

      .empty-state {
        padding: 30px 15px;
        font-size: 14px;
      }

      .empty-state::before {
        font-size: 36px;
      }

      /* 모바일 채팅창 스타일 */
      .chat-container {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
        border: none;
      }

      .chat-container.hidden {
        transform: translateY(100%);
      }

      .chat-header {
        border-radius: 0;
        padding: 16px;
      }

      .chat-close-btn {
        display: flex;
      }

      .chat-toggle-btn {
        display: flex;
        bottom: 80px;
        right: 20px;
        left: auto;
      }

      .chat-message .text {
        max-width: calc(100vw - 80px);
      }

      /* 모바일 랭킹 테이블 스타일 */
      .ranking-table {
        font-size: 11px;
        table-layout: fixed;
        width: 100%;
      }

      .ranking-table th {
        padding: 8px 2px;
        font-size: 10px;
        white-space: nowrap;
      }

      .ranking-table td {
        padding: 8px 2px;
        white-space: nowrap;
      }

      .ranking-table td.rank {
        font-size: 12px;
        width: 35px;
      }

      .ranking-table td.nickname {
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }

      .ranking-table td.nickname .nickname-link {
        padding: 3px 8px;
        font-size: 12px;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .ranking-table td.nickname .tier-badge {
        padding: 2px 6px;
        font-size: 10px;
      }

      .ranking-table td.winrate {
        font-size: 11px;
        width: 50px;
      }

      .ranking-table td.total-games {
        font-size: 11px;
        width: 50px;
      }

      /* 모바일에서 승/패 컬럼 숨기기 (공간 절약) */
      .ranking-table th:nth-child(4),
      .ranking-table th:nth-child(5),
      .ranking-table td:nth-child(4),
      .ranking-table td:nth-child(5) {
        display: none;
      }

      .ranking-tabs {
        gap: 4px;
      }

      .ranking-tab {
        padding: 8px 12px;
        font-size: 12px;
      }

      /* 모바일 토스트 알림 */
      .toast-container {
        top: 60px;
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .toast {
        min-width: auto;
        width: 100%;
        padding: 12px 16px;
        box-sizing: border-box;
        animation: slideInMobile 0.3s ease-out;
      }

      .toast.slide-out {
        animation: slideOutMobile 0.3s ease-out forwards;
      }

      @keyframes slideInMobile {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideOutMobile {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }

      .toast-icon {
        font-size: 20px;
      }

      .toast-message {
        font-size: 13px;
      }

      .modal-content {
        max-width: 95%;
        padding: 20px 12px;
      }

      .modal-content h2 {
        font-size: 18px;
      }
    }

    /* ===== 매칭 모달 스타일 ===== */
    .matchmaking-modal .modal-content {
      text-align: center;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border: 2px solid #4a7c59;
      border-radius: 16px;
      box-shadow:
        0 0 30px rgba(74, 124, 89, 0.3),
        0 20px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255,255,255,0.1);
      padding: 2rem;
    }

    .matchmaking-modal .modal-content h2 {
      color: #4ade80 !important;
      text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    .matchmaking-timer {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(74, 222, 128, 0.2);
    }

    .matchmaking-timer .timer-label {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.3rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .matchmaking-timer .timer-value {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Courier New', monospace;
      text-shadow: none;
    }

    .rating-range-info {
      font-size: 1rem;
      color: #9ca3af;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(139, 92, 246, 0.15);
      border-radius: 20px;
      display: inline-block;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .rating-range-info span:last-child {
      font-weight: 700;
      color: #a78bfa;
    }

    .status-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e5e7eb;
      margin: 1rem 0;
    }

    /* 로딩 스피너 */
    .loading-spinner {
      width: 80px;
      height: 80px;
      position: relative;
      margin: 1.5rem auto;
    }

    .loading-spinner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 4px solid rgba(74, 222, 128, 0.2);
      border-radius: 50%;
      border-top-color: #4ade80;
      border-right-color: #22c55e;
      animation: spin 1s linear infinite;
      box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
    }

    .loading-spinner::after {
      content: '';
      position: absolute;
      top: 10px;
      left: 10px;
      width: calc(100% - 20px);
      height: calc(100% - 20px);
      border: 3px solid rgba(139, 92, 246, 0.2);
      border-radius: 50%;
      border-bottom-color: #a78bfa;
      border-left-color: #8b5cf6;
      animation: spin 1.5s linear infinite reverse;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 대기 점 애니메이션 */
    .dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 25% { content: '.'; }
      26%, 50% { content: '..'; }
      51%, 75% { content: '...'; }
      76%, 100% { content: ''; }
    }

    /* 매칭 아이콘 (회전 화살표) */
    .match-icon {
      width: 90px;
      height: 90px;
      position: relative;
      margin: 1.5rem auto;
    }

    .match-icon .circle-arrow {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 4px solid #4ade80;
      border-radius: 50%;
      border-top-color: transparent;
      box-shadow: 0 0 15px rgba(74, 222, 128, 0.4);
      border-right-color: transparent;
      animation: rotateArrow 1.5s ease-in-out infinite;
    }

    .match-icon .circle-arrow:nth-child(2) {
      transform: rotate(180deg);
      animation-delay: -0.75s;
    }

    @keyframes rotateArrow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 상대방 정보 */
    .opponent-info {
      margin: 1.5rem 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
      border-radius: 16px;
      border: 1px solid rgba(74, 222, 128, 0.3);
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .opponent-profile-img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(74, 222, 128, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      margin-bottom: 0.5rem;
    }

    .opponent-info p:first-child {
      color: #9ca3af !important;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.8rem !important;
    }

    .opponent-info .opponent-nickname {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .opponent-info .opponent-nickname #opponent-nickname {
      background: linear-gradient(135deg, #fff, #e5e7eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .opponent-info .opponent-rating {
      font-size: 1.1rem;
      font-weight: 600;
      color: #a78bfa;
      margin: 0;
    }

    /* 수락 카운트다운 바 */
    .accept-countdown {
      margin: 1.5rem 0;
    }

    .countdown-bar-container {
      width: 100%;
      height: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 0.5rem;
      border: 1px solid rgba(74, 222, 128, 0.2);
    }

    .countdown-bar {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e, #16a34a);
      border-radius: 5px;
      transition: width 0.1s linear;
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
    }

    .countdown-text {
      color: #e5e7eb;
      font-size: 0.95rem;
    }

    .countdown-text span {
      font-weight: 700;
      color: #4ade80;
      font-size: 1.1rem;
    }

    .countdown-text {
      font-size: 1rem;
      color: #666;
    }

    .countdown-text span {
      font-weight: 700;
      color: #d84315;
    }

    /* 모달 버튼 스타일 */
    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.accept {
      background: #4a7c59;
      color: white;
    }

    .modal-btn.accept:hover {
      background: #3a6c49;
    }

    .modal-btn.decline,
    .modal-btn.cancel {
      background: #999;
      color: white;
    }

    .modal-btn.decline:hover,
    .modal-btn.cancel:hover {
      background: #777;
    }

    /* 매칭 모달 버튼 스타일 오버라이드 */
    .matchmaking-modal .modal-btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 2px solid transparent;
    }

    .matchmaking-modal .modal-btn.accept {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: #0f1419;
      border-color: #4ade80;
      box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
    }

    .matchmaking-modal .modal-btn.accept:hover {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 222, 128, 0.5);
    }

    .matchmaking-modal .modal-btn.decline,
    .matchmaking-modal .modal-btn.cancel {
      background: transparent;
      color: #9ca3af;
      border-color: #4b5563;
    }

    .matchmaking-modal .modal-btn.decline:hover,
    .matchmaking-modal .modal-btn.cancel:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border-color: #f87171;
    }

    .matchmaking-modal .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 1rem;
    }

    /* RP 매칭 버튼 */
    .btn-matchmaking {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c4dff 100%);
      color: white;
      font-weight: 700;
    }

    .btn-matchmaking:hover {
      background: linear-gradient(135deg, #7c4dff 0%, #6c3de6 100%);
    }

    .btn-matchmaking:disabled {
      background: #999;
      cursor: not-allowed;
    }

    /* AI 대전 버튼 */
    .btn-ai {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-weight: 700;
    }

    .btn-ai:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    [data-theme="dark"] .btn-ai {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    [data-theme="dark"] .btn-ai:hover {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    /* AI 모달 옵션 */
    .ai-options {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .option-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .option-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }

    .option-buttons {
      display: flex;
      gap: 8px;
    }

    .option-btn {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid var(--card-border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .option-btn:hover {
      border-color: #10b981;
    }

    .option-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-color: #10b981;
      color: white;
    }

    [data-theme="dark"] .option-btn {
      background: var(--input-bg);
      border-color: #374151;
    }

    [data-theme="dark"] .option-btn:hover {
      border-color: #4ade80;
    }

    [data-theme="dark"] .option-btn.active {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      border-color: #4ade80;
    }

    /* 초소형 모바일 */
    @media (max-width: 375px) {
      .header {
        padding: 12px;
      }

      .header h1 {
        font-size: 20px;
      }

      .stone {
        width: 20px;
        height: 20px;
      }

      .stone-black::after,
      .stone-white::after {
        top: 3px;
        left: 5px;
        width: 6px;
        height: 4px;
      }

      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .rooms-section {
        padding: 12px;
      }

      .room-card {
        padding: 12px;
      }

      .room-card .room-title {
        font-size: 15px;
      }

      .room-card .room-info {
        font-size: 11px;
      }
    }

    /* 신고 버튼 (채팅 메시지) */
    .chat-message .report-btn {
      display: none;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 11px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 2px;
    }

    .chat-message .report-btn:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .chat-message:hover .report-btn {
      display: inline-block;
    }

    /* 모바일: 항상 표시 */
    @media (max-width: 768px) {
      .chat-message .report-btn {
        display: inline-block;
      }
    }

    /* 신고 모달 */
    .report-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .report-modal.active {
      display: flex;
    }

    .report-modal .report-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: modalFadeIn 0.3s ease;
    }

    .report-modal .report-content h3 {
      margin: 0 0 6px;
      font-size: 1.2rem;
      color: var(--text);
    }

    .report-modal .report-target {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .report-modal label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .report-modal select,
    .report-modal textarea {
      width: 100%;
      padding: 8px 10px;
      border: 2px solid var(--line);
      border-radius: 6px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      margin-bottom: 14px;
      box-sizing: border-box;
    }

    .report-modal select:focus,
    .report-modal textarea:focus {
      outline: none;
      border-color: var(--border);
    }

    .report-modal textarea {
      resize: vertical;
      min-height: 70px;
    }

    .report-modal .report-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .report-modal .report-actions button {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .report-modal .btn-report-cancel {
      background: #6b7280;
      color: #fff;
    }

    .report-modal .btn-report-submit {
      background: #ef4444;
      color: #fff;
    }

    .report-modal .btn-report-submit:hover {
      background: #dc2626;
    }

    [data-theme="dark"] .report-modal .report-content {
      background: #16213e;
      border: 1px solid #2d3748;
    }
  </style>
</head>
<body>
  {% csrf_token %}
  <div class="container">
    <div class="header">
      <div class="header-title-row">
        <h1>
          <span class="logo-stones">
            <span class="stone stone-black"></span>
            <span class="stone stone-white"></span>
          </span>
          오목조목 로비
        </h1>
        <button class="btn theme-toggle mobile-theme-toggle" id="theme-toggle-mobile">다크모드</button>
        <a href="{% url 'account_logout' %}" class="btn logout-btn mobile-logout">로그아웃</a>
      </div>
      <div class="header-user-row">
        <span class="user-info">
          <span class="my-tier-slot" data-rating="{{ my_rating }}" data-total-games="{{ my_total_games }}"></span>
          <span class="my-nickname">{{ user.first_name|default:user.username }}</span>
        </span>
        {% if user.is_staff %}
        <a href="{% url 'games:admin_panel' %}" class="admin-badge">관리자</a>
        {% endif %}
      </div>
      <div class="top-actions">
        <a href="{% url 'games:friends' %}" class="btn" style="background: #4a7c89; position: relative;">
          친구 목록
          <span id="friendNotificationBadge" style="display: none; position: absolute; top: -4px; right: -4px; background: #e53e3e; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700;"></span>
        </a>
        <a href="{% url 'games:history' %}" class="btn" style="background: #5a4a3a;">내 전적</a>
        <button class="btn" id="ranking-btn" style="background: #4a7c59;">랭킹</button>
        <button class="btn" id="tier-list-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">티어표</button>
        <a href="{% url 'accounts:profile_edit' %}" class="btn" style="background: #6a5d4a;">프로필</a>
        <div class="action-group">
          <button class="btn" id="settings-btn" style="background: #6b7280;">설정</button>
          <a href="{% url 'account_logout' %}" class="btn logout-btn">로그아웃</a>
          <button class="btn theme-toggle" id="theme-toggle">다크모드</button>
        </div>
      </div>
    </div>

    <!-- 접속자 목록 -->
    <div class="online-users-section">
      <div class="online-users-header">
        <h3>현재 접속자</h3>
        <span class="online-count" id="online-count">0명</span>
      </div>
      <div class="users-list" id="users-list">
        <span class="ws-status" id="ws-status">연결 중...</span>
      </div>
    </div>

    {% if active_game_id %}
    <div class="active-game-banner">
      <div class="banner-content">
        <span class="banner-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="rgba(255,255,255,0.2)"/><circle cx="12" cy="12" r="6" fill="white"/><circle cx="12" cy="12" r="3" fill="rgba(74,124,89,0.8)"/></svg></span>
        <div class="banner-text">
          <strong>진행 중인 게임이 있습니다</strong>
          <p>게임을 계속하시려면 재입장하세요</p>
        </div>
      </div>
      <a href="{% url 'games:room' pk=active_game_id %}" class="btn btn-rejoin">게임 재입장</a>
    </div>
    {% endif %}

    <div class="rooms-section">
      <div class="rooms-header">
        <h2>대기 중인 게임 방</h2>
        <div style="display: flex; gap: 8px;">
          {% if has_active_game %}
            <button class="btn btn-matchmaking" disabled title="진행 중인 게임이 있습니다">RP 매칭</button>
            <button class="btn btn-ai" id="ai-game-btn">AI 대전</button>
            <button class="btn" disabled title="진행 중인 게임이 있습니다">공개 방 만들기</button>
          {% else %}
            <button class="btn btn-matchmaking" id="matchmaking-btn">RP 매칭</button>
            <button class="btn btn-ai" id="ai-game-btn">AI 대전</button>
            <button class="btn" id="new-room-btn">공개 방 만들기</button>
          {% endif %}
        </div>
      </div>

      <div class="room-list" id="room-list">
        {% if waiting_games %}
          {% for game in waiting_games %}
            <div class="room-card" data-game-id="{{ game.pk }}" data-has-password="{% if game.password %}true{% else %}false{% endif %}" data-game-url="{% url 'games:join' pk=game.pk %}">
              <div class="room-title">
                {% if game.password %}🔒 {% endif %}{{ game.title }}
              </div>
              <div class="room-info">
                <span>생성자: <a href="{% url 'accounts:profile' username=game.black.username %}" class="nickname-link" data-tooltip="프로필 보기" onclick="event.stopPropagation();">{{ game.black.first_name|default:game.black.username }}</a></span>
                <span>|</span>
                <span>생성 시간: {{ game.created_at|date:"Y-m-d H:i" }}</span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            대기 중인 방이 없습니다.<br>
            새 방을 만들어보세요!
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 채팅 토글 버튼 (모바일용) -->
  <button class="chat-toggle-btn" id="chat-toggle-btn" aria-label="채팅 열기">💬</button>

  <!-- 채팅창 -->
  <div class="chat-container hidden" id="chat-container">
    <div class="chat-header">
      <span>오목조목 채팅</span>
      <button class="chat-close-btn" id="chat-close-btn" aria-label="채팅 닫기">×</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <!-- 채팅 메시지가 여기에 추가됩니다 -->
    </div>
    <div class="chat-input-container">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="메시지를 입력하세요..."
        maxlength="200"
      />
      <button id="chat-send-btn" class="chat-send-btn">전송</button>
    </div>
  </div>

  <!-- 제목 입력 모달 -->
  <div class="modal-overlay" id="title-modal">
    <div class="modal-content">
      <h2>새 게임 방 만들기</h2>
      <form id="new-room-form" method="post" action="{% url 'games:new' %}">
        {% csrf_token %}
        <input
          type="text"
          id="room-title"
          name="title"
          placeholder="방 제목을 입력하세요"
          maxlength="100"
          autofocus
        />
        <input
          type="password"
          id="room-password"
          name="password"
          placeholder="비밀번호 (선택사항)"
          maxlength="128"
        />
        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" id="cancel-btn">취소</button>
          <button type="submit" class="btn">만들기</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AI 대전 모달 -->
  <div class="modal-overlay" id="ai-modal">
    <div class="modal-content">
      <h2>AI 대전</h2>
      <div class="ai-options">
        <div class="option-group">
          <label>난이도</label>
          <div class="option-buttons">
            <button class="option-btn" data-difficulty="easy">EASY</button>
            <button class="option-btn active" data-difficulty="normal">NORMAL
            </button>
            <button class="option-btn" data-difficulty="hard">HARD</button>
          </div>
        </div>
        <div class="option-group">
          <label>돌 색상</label>
          <div class="option-buttons">
            <button class="option-btn active" data-color="B">흑 (선공)</button>
            <button class="option-btn" data-color="W">백 (후공)</button>
          </div>
        </div>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-cancel" id="ai-cancel-btn">취소</button>
        <button type="button" class="btn btn-ai" id="ai-start-btn">게임 시작</button>
      </div>
    </div>
  </div>

  <!-- 비밀번호 입력 모달 -->
  <div class="modal-overlay" id="password-modal">
    <div class="modal-content">
      <h2>비밀번호 입력</h2>
      <form id="password-form" method="post">
        {% csrf_token %}
        <input
          type="password"
          id="game-password"
          name="password"
          placeholder="비밀번호를 입력하세요"
          maxlength="128"
          autofocus
        />
        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" id="password-cancel-btn">취소</button>
          <button type="submit" class="btn">입장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 랭킹 모달 -->
  <div class="modal-overlay" id="ranking-modal">
    <div class="modal-content" style="max-width: 600px;">
      <h2>오목조목 랭킹</h2>

      <!-- 랭킹 탭 -->
      <div class="ranking-tabs">
        <button class="ranking-tab active" data-tab="rating">RP</button>
        <button class="ranking-tab" data-tab="winrate">승률</button>
        <button class="ranking-tab" data-tab="games">판수</button>
      </div>

      <!-- RP 순위 -->
      <div id="ranking-rating" class="ranking-content">
        {% if ranking_by_rating %}
        <table class="ranking-table ranking-table-compact">
          <thead>
            <tr>
              <th style="width: 50px;">순위</th>
              <th style="text-align: left;">닉네임</th>
              <th style="width: 80px;">RP</th>
            </tr>
          </thead>
          <tbody>
            {% for item in ranking_by_rating %}
            <tr>
              <td class="rank">{{ item.rank }}</td>
              <td class="nickname">
                <span class="tier-slot" data-rating="{{ item.rating }}"></span>
                <a href="{% url 'accounts:profile' username=item.username %}" class="nickname-link" data-tooltip="{{ item.wins }}승 {{ item.losses }}패 ({{ item.win_rate }}%)">
                  {{ item.nickname }}
                </a>
              </td>
              <td class="rating" style="font-weight: 700; color: #8b5cf6;">{{ item.rating }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-ranking">
          아직 랭킹 데이터가 없습니다.<br>
          5판 이상 플레이하면 순위에 등록됩니다!
        </div>
        {% endif %}
      </div>

      <!-- 승률 순위 -->
      <div id="ranking-winrate" class="ranking-content hidden">
        {% if ranking_by_winrate %}
        <table class="ranking-table">
          <thead>
            <tr>
              <th style="width: 50px;">순위</th>
              <th style="text-align: left;">닉네임</th>
              <th style="width: 70px;">승률</th>
              <th style="width: 60px;">승</th>
              <th style="width: 60px;">패</th>
              <th style="width: 70px;">RP</th>
            </tr>
          </thead>
          <tbody>
            {% for item in ranking_by_winrate %}
            <tr>
              <td class="rank">{{ item.rank }}</td>
              <td class="nickname">
                <span class="tier-slot" data-rating="{{ item.rating }}"></span>
                <a href="{% url 'accounts:profile' username=item.username %}" class="nickname-link" data-tooltip="RP: {{ item.rating }} | {{ item.wins }}승 {{ item.losses }}패">
                  {{ item.nickname }}
                </a>
              </td>
              <td class="winrate">{{ item.win_rate }}%</td>
              <td>{{ item.wins }}</td>
              <td>{{ item.losses }}</td>
              <td class="rating" style="font-weight: 700; color: #8b5cf6;">{{ item.rating }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-ranking">
          아직 랭킹 데이터가 없습니다.<br>
          5판 이상 플레이하면 순위에 등록됩니다!
        </div>
        {% endif %}
      </div>

      <!-- 판수 순위 -->
      <div id="ranking-games" class="ranking-content hidden">
        {% if ranking_by_games %}
        <table class="ranking-table ranking-table-compact">
          <thead>
            <tr>
              <th style="width: 50px;">순위</th>
              <th style="text-align: left;">닉네임</th>
              <th style="width: 80px;">총 판수</th>
            </tr>
          </thead>
          <tbody>
            {% for item in ranking_by_games %}
            <tr>
              <td class="rank">{{ item.rank }}</td>
              <td class="nickname">
                <span class="tier-slot" data-rating="{{ item.rating }}"></span>
                <a href="{% url 'accounts:profile' username=item.username %}" class="nickname-link" data-tooltip="{{ item.wins }}승 {{ item.losses }}패 ({{ item.win_rate }}%)">
                  {{ item.nickname }}
                </a>
              </td>
              <td class="total-games">{{ item.total_games }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-ranking">
          아직 랭킹 데이터가 없습니다.<br>
          게임을 플레이하여 랭킹에 도전하세요!
        </div>
        {% endif %}
      </div>

      <div class="modal-buttons" style="margin-top: 20px;">
        <button type="button" class="btn" id="ranking-close-btn" style="width: 100%;">닫기</button>
      </div>
    </div>
  </div>

  <!-- 티어 목록 모달 -->
  <div class="modal-overlay" id="tier-list-modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2 style="display: flex; align-items: center; gap: 8px; justify-content: center;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        티어 목록
      </h2>
      <p style="text-align: center; color: #666; margin-bottom: 1rem; font-size: 0.9rem;">5판의 배치전 후 티어가 결정됩니다</p>

      <div class="tier-list-container">
        <!-- 최상위 티어 -->
        <div class="tier-group tier-group-legendary">
          <div class="tier-group-title">전설</div>
          <div class="tier-item">
            <span class="tier-badge tier-무신">무신</span>
            <span class="tier-rp">2200+</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-투신">투신</span>
            <span class="tier-rp">2100 ~ 2199</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-패왕">패왕</span>
            <span class="tier-rp">2000 ~ 2099</span>
          </div>
        </div>

        <!-- 마스터 티어 -->
        <div class="tier-group tier-group-master">
          <div class="tier-group-title">마스터</div>
          <div class="tier-item">
            <span class="tier-badge tier-지존">지존</span>
            <span class="tier-rp">1900 ~ 1999</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-명인">명인</span>
            <span class="tier-rp">1800 ~ 1899</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-달인">달인</span>
            <span class="tier-rp">1700 ~ 1799</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-낭인">낭인</span>
            <span class="tier-rp">1600 ~ 1699</span>
          </div>
        </div>

        <!-- 골드 티어 -->
        <div class="tier-group tier-group-gold">
          <div class="tier-group-title">골드</div>
          <div class="tier-item">
            <span class="tier-badge tier-3단">3단</span>
            <span class="tier-rp">1500 ~ 1599</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-2단">2단</span>
            <span class="tier-rp">1400 ~ 1499</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-1단">1단</span>
            <span class="tier-rp">1300 ~ 1399</span>
          </div>
        </div>

        <!-- 실버 티어 -->
        <div class="tier-group tier-group-silver">
          <div class="tier-group-title">실버</div>
          <div class="tier-item">
            <span class="tier-badge tier-1급">1급</span>
            <span class="tier-rp">1200 ~ 1299</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-2급">2급</span>
            <span class="tier-rp">1100 ~ 1199</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-3급">3급</span>
            <span class="tier-rp">1000 ~ 1099</span>
          </div>
        </div>

        <!-- 브론즈 티어 -->
        <div class="tier-group tier-group-bronze">
          <div class="tier-group-title">브론즈</div>
          <div class="tier-item">
            <span class="tier-badge tier-4급">4급</span>
            <span class="tier-rp">900 ~ 999</span>
          </div>
          <div class="tier-item">
            <span class="tier-badge tier-5급">5급</span>
            <span class="tier-rp">0 ~ 899</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons" style="margin-top: 20px;">
        <button type="button" class="btn" id="tier-list-close-btn" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">닫기</button>
      </div>
    </div>
  </div>

  <!-- 매칭 검색 모달 -->
  <div class="modal-overlay matchmaking-modal" id="matchmaking-search-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">RP 매칭</h2>

      <div class="loading-spinner"></div>

      <div class="matchmaking-timer">
        <span class="timer-label">검색 시간</span>
        <span id="matchmaking-timer" class="timer-value">00:00</span>
      </div>

      <div class="rating-range-info">
        <span>검색 범위: </span>
        <span id="rating-range">±50</span>
      </div>

      <p class="status-text">
        상대를 찾는중<span class="dots"></span>
      </p>

      <button class="modal-btn cancel" id="matchmaking-cancel-btn">취소</button>
    </div>
  </div>

  <!-- 매칭 성공 모달 -->
  <div class="modal-overlay matchmaking-modal" id="match-found-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">매칭 성공!</h2>

      <div class="match-icon">
        <div class="circle-arrow"></div>
        <div class="circle-arrow"></div>
      </div>

      <div class="opponent-info">
        <img id="opponent-profile-img" src="/static/images/default_profile_green.svg" alt="상대방" class="opponent-profile-img">
        <p style="font-size: 0.9rem; color: #666; margin: 0;">상대방</p>
        <p class="opponent-nickname">
          <span id="opponent-tier"></span>
          <span id="opponent-nickname">Player123</span>
        </p>
        <p class="opponent-rating">RP: <span id="opponent-rating">1050</span></p>
      </div>

      <div class="accept-countdown">
        <div class="countdown-bar-container">
          <div class="countdown-bar" id="countdown-bar" style="width: 100%;"></div>
        </div>
        <p class="countdown-text"><span id="accept-countdown">10</span>초 안에 수락하세요</p>
      </div>

      <div class="modal-buttons">
        <button class="modal-btn accept" id="match-accept-btn">수락</button>
        <button class="modal-btn decline" id="match-decline-btn">거절</button>
      </div>
    </div>
  </div>

  <!-- 상대방 수락 대기 모달 -->
  <div class="modal-overlay matchmaking-modal" id="waiting-accept-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">매칭 성공!</h2>

      <div class="loading-spinner"></div>

      <p class="status-text">
        상대방 수락 대기중<span class="dots"></span>
      </p>

      <button class="modal-btn cancel" id="waiting-cancel-btn">취소</button>
    </div>
  </div>


  <!-- 설정 모달 -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content" style="max-width: 360px;">
      <h2>설정</h2>

      <div class="settings-group">
        <div class="settings-row">
          <span class="settings-label">배경음악</span>
          <label class="toggle-switch">
            <input type="checkbox" id="bgm-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-label" style="font-size: 13px; color: var(--text-secondary);">BGM 볼륨</span>
          <div class="volume-control">
            <input type="range" id="bgm-volume" min="0" max="100" value="30" class="volume-slider">
            <span class="volume-value" id="bgm-volume-value">30%</span>
          </div>
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-row">
          <span class="settings-label">효과음</span>
          <label class="toggle-switch">
            <input type="checkbox" id="sfx-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-label" style="font-size: 13px; color: var(--text-secondary);">효과음 볼륨</span>
          <div class="volume-control">
            <input type="range" id="sfx-volume" min="0" max="100" value="50" class="volume-slider">
            <span class="volume-value" id="sfx-volume-value">50%</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-btn cancel" id="settings-close-btn" style="flex:1;">닫기</button>
      </div>
    </div>
  </div>

  <!-- BGM Audio Elements -->
  <audio id="bgm-lobby" loop preload="auto">
    <source src="{% static 'audio/lobby.mp3' %}" type="audio/mpeg">
  </audio>
  <audio id="bgm-matchmaking" loop preload="auto">
    <source src="{% static 'audio/matchmaking.mp3' %}" type="audio/mpeg">
  </audio>
  <audio id="bgm-match-found" loop preload="auto">
    <source src="{% static 'audio/match_found.mp3' %}" type="audio/mpeg">
  </audio>

  <script>
  // 티어 시스템
  const TIERS = [
    { name: "5급", minRp: 0, maxRp: 899, color: "#6b7280", bgColor: "#f3f4f6" },
    { name: "4급", minRp: 900, maxRp: 999, color: "#3b82f6", bgColor: "#eff6ff" },
    { name: "3급", minRp: 1000, maxRp: 1099, color: "#06b6d4", bgColor: "#ecfeff" },
    { name: "2급", minRp: 1100, maxRp: 1199, color: "#10b981", bgColor: "#ecfdf5" },
    { name: "1급", minRp: 1200, maxRp: 1299, color: "#22c55e", bgColor: "#f0fdf4" },
    { name: "1단", minRp: 1300, maxRp: 1399, color: "#84cc16", bgColor: "#f7fee7" },
    { name: "2단", minRp: 1400, maxRp: 1499, color: "#eab308", bgColor: "#fefce8" },
    { name: "3단", minRp: 1500, maxRp: 1599, color: "#f59e0b", bgColor: "#fffbeb" },
    { name: "낭인", minRp: 1600, maxRp: 1699, color: "#8b5cf6", bgColor: "#f5f3ff" },
    { name: "달인", minRp: 1700, maxRp: 1799, color: "#a855f7", bgColor: "#faf5ff" },
    { name: "명인", minRp: 1800, maxRp: 1899, color: "#ec4899", bgColor: "#fdf2f8" },
    { name: "지존", minRp: 1900, maxRp: 1999, color: "#f43f5e", bgColor: "#fff1f2" },
    { name: "패왕", minRp: 2000, maxRp: 2099, color: "#ef4444", bgColor: "#fef2f2" },
    { name: "투신", minRp: 2100, maxRp: 2199, color: "#dc2626", bgColor: "#fef2f2" },
    { name: "무신", minRp: 2200, maxRp: Infinity, color: "#b91c1c", bgColor: "#1f1f1f" },
  ];

  // 티어 아이콘 SVG
  function getTier(rp) {
    for (const tier of TIERS) {
      if (rp >= tier.minRp && rp <= tier.maxRp) {
        return tier;
      }
    }
    return TIERS[0];
  }

  function getTierBadgeHTML(rp, totalGames = 999) {
    // 5판 미만이면 "배치중" 표시
    if (totalGames < 5) {
      return `<span class="tier-badge tier-placement">배치중</span>`;
    }
    const tier = getTier(rp);
    return `<span class="tier-badge tier-${tier.name}">${tier.name}</span>`;
  }

  function getTierRangeDisplay(rp, rangeDelta) {
    const minRp = Math.max(0, rp - rangeDelta);
    const maxRp = rp + rangeDelta;
    const minTier = getTier(minRp);
    const maxTier = getTier(maxRp);
    const tierText = minTier.name === maxTier.name
      ? minTier.name
      : `${minTier.name} ~ ${maxTier.name}`;
    return tierText;
  }

  // 전역에서 사용 가능하도록
  window.getTier = getTier;
  window.getTierBadgeHTML = getTierBadgeHTML;
  window.getTierRangeDisplay = getTierRangeDisplay;

  (function(){
    const scheme = (location.protocol === "https:") ? "wss" : "ws";
    const wsURL = `${scheme}://${location.host}/ws/lobby/`;

    const wsStatus = document.getElementById("ws-status");
    const usersList = document.getElementById("users-list");
    const onlineCount = document.getElementById("online-count");

    let ws = null;

    function connect() {
      ws = new WebSocket(wsURL);

      // WebSocket을 전역에서 접근 가능하도록
      window.lobbyWs = ws;

      ws.addEventListener("open", () => {
        console.log("[Lobby] WebSocket connected");
        wsStatus.textContent = "연결됨";
        wsStatus.className = "ws-status connected";
      });

      ws.addEventListener("close", (e) => {
        console.log("[Lobby] WebSocket closed:", e.code);
        wsStatus.textContent = "연결 끊김";
        wsStatus.className = "ws-status disconnected";

        // 5초 후 재연결 시도
        setTimeout(() => {
          console.log("[Lobby] Reconnecting...");
          connect();
        }, 5000);
      });

      ws.addEventListener("error", (e) => {
        console.error("[Lobby] WebSocket error:", e);
        wsStatus.textContent = "연결 오류";
        wsStatus.className = "ws-status disconnected";
      });

      ws.addEventListener("message", (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === "users") {
            renderUsers(data.users);
          } else if (data.type === "room_list") {
            renderRoomList(data.games);
          } else if (data.type === "chat_history") {
            // 최근 24시간 채팅 기록 로드
            data.messages.forEach(msg => {
              addChatMessage(msg.sender, msg.message, msg.is_mine, msg.rating || 1000, msg.total_games || 0, msg.sender_id || null, msg.profile_image || null);
            });
          } else if (data.type === "chat_message") {
            addChatMessage(data.sender, data.message, data.is_mine, data.rating || 1000, data.total_games || 0, data.sender_id || null, data.profile_image || null);
          } else if (data.type === "chat_error") {
            if (window.showToast) {
              window.showToast(data.message, "error");
            } else {
              alert(data.message);
            }
          } else if (data.type === "game_invite") {
            // 게임 초대 수신
            showInviteToast(data.invite_id, data.from_nickname);
          } else if (data.type === "invite_accepted") {
            // 초대 수락됨 - 게임방으로 이동
            if (window.showToast) {
              window.showToast(`${data.opponent_nickname}님이 초대를 수락했습니다!`, "success");
            }
            setTimeout(() => {
              window.location.href = data.game_url;
            }, 500);
          } else if (data.type === "invite_declined") {
            // 초대 거절됨
            if (window.showToast) {
              window.showToast(`${data.declined_by}님이 초대를 거절했습니다.`, "info");
            }
          } else if (data.type === "invite_error") {
            // 초대 오류
            if (window.showToast) {
              window.showToast(data.message, "error");
            }
          }
        } catch (err) {
          console.error("[Lobby] Message parse error:", err);
        }
      });
    }

    function renderRoomList(games) {
      const roomList = document.getElementById("room-list");
      if (!roomList) return;

      roomList.innerHTML = "";

      if (!games || games.length === 0) {
        const emptyState = document.createElement("div");
        emptyState.className = "empty-state";
        emptyState.innerHTML = "대기 중인 방이 없습니다.<br>새 방을 만들어보세요!";
        roomList.appendChild(emptyState);
        return;
      }

      games.forEach(game => {
        const card = document.createElement("div");
        card.className = "room-card";
        card.dataset.gameId = game.id;
        card.dataset.hasPassword = game.has_password ? "true" : "false";
        card.dataset.gameUrl = `/games/${game.id}/join/`;

        const titleDiv = document.createElement("div");
        titleDiv.className = "room-title";
        titleDiv.textContent = (game.has_password ? "🔒 " : "") + game.title;
        card.appendChild(titleDiv);

        const infoDiv = document.createElement("div");
        infoDiv.className = "room-info";

        // 생성자 링크
        const creatorSpan = document.createElement("span");
        creatorSpan.innerHTML = `생성자: <a href="/accounts/profile/${game.black_username}/" class="nickname-link" data-tooltip="프로필 보기" onclick="event.stopPropagation();">${game.black_nickname}</a>`;
        infoDiv.appendChild(creatorSpan);

        // 구분자
        const separator = document.createElement("span");
        separator.textContent = "|";
        infoDiv.appendChild(separator);

        // RP 정보
        const rpSpan = document.createElement("span");
        rpSpan.innerHTML = getTierBadgeHTML(game.black_rating, game.black_total_games);
        infoDiv.appendChild(rpSpan);

        card.appendChild(infoDiv);
        roomList.appendChild(card);

        // 클릭 이벤트 바인딩
        card.addEventListener("click", (e) => {
          window.handleRoomCardClick(card, e);
        });
      });
    }

    // 방 카드 클릭 핸들러 (전역 함수로 정의)
    window.handleRoomCardClick = function(card, e) {
      // 닉네임 링크 클릭 시 이벤트 전파 방지 확인
      if (e && e.target && e.target.classList.contains('nickname-link')) {
        return;
      }

      const hasPassword = card.dataset.hasPassword === "true";
      const gameUrl = card.dataset.gameUrl;

      if (hasPassword) {
        // 비밀번호 입력 모달 표시
        const passwordModal = document.getElementById("password-modal");
        const gamePasswordInput = document.getElementById("game-password");
        const passwordForm = document.getElementById("password-form");
        if (passwordModal && gamePasswordInput && passwordForm) {
          // 선택된 게임 URL 저장 (submit 시 사용)
          passwordForm.dataset.gameUrl = gameUrl;
          gamePasswordInput.value = "";
          passwordModal.classList.add("active");
          setTimeout(() => gamePasswordInput.focus(), 100);
        }
      } else {
        window.location.href = gameUrl;
      }
    };

    function renderUsers(users) {
      // 접속자 수 업데이트
      onlineCount.textContent = `${users.length}명`;

      // 접속자 목록 업데이트
      usersList.innerHTML = "";

      if (users.length === 0) {
        const emptyMsg = document.createElement("span");
        emptyMsg.className = "ws-status";
        emptyMsg.textContent = "접속자가 없습니다";
        usersList.appendChild(emptyMsg);
        return;
      }

      users.forEach(user => {
        const badge = document.createElement("div");
        badge.className = "user-badge";

        // 프로필 이미지
        const profileImg = document.createElement("img");
        profileImg.className = "user-profile-img";
        profileImg.src = user.profile_image || "/static/images/default_profile_green.svg";
        profileImg.alt = user.nickname;
        badge.appendChild(profileImg);

        // 티어 뱃지 추가 (total_games가 5 미만이면 "배치중" 표시)
        const tierBadge = document.createElement("span");
        tierBadge.innerHTML = getTierBadgeHTML(user.rating || 1000, user.total_games || 0);
        badge.appendChild(tierBadge.firstChild);

        // 닉네임 버튼 생성 (클릭 시 드롭다운)
        const nicknameBtn = document.createElement("span");
        nicknameBtn.className = "nickname-link";
        nicknameBtn.style.cursor = "pointer";
        nicknameBtn.textContent = user.nickname;
        nicknameBtn.dataset.userId = user.user_id;
        nicknameBtn.dataset.username = user.username;
        nicknameBtn.dataset.nickname = user.nickname;

        // 사용자 상태에 따라 스타일 및 텍스트 적용
        if (user.status === "playing") {
          badge.classList.add("playing");
          nicknameBtn.textContent = `${user.nickname} - 게임중`;
        } else if (user.status === "waiting") {
          badge.classList.add("waiting");
          nicknameBtn.textContent = `${user.nickname} - 게임룸 대기중`;
        } else if (user.status === "matchmaking") {
          badge.classList.add("matchmaking");
          nicknameBtn.textContent = `${user.nickname} - RP매칭중`;
        } else if (user.status === "ai_playing") {
          badge.classList.add("ai_playing");
          nicknameBtn.textContent = `${user.nickname} - AI대전중`;
        }

        badge.appendChild(nicknameBtn);

        // 드롭다운 메뉴 생성 (본인이면 프로필만)
        const dropdown = document.createElement("div");
        dropdown.className = "user-dropdown";
        const currentUsername = "{{ user.username }}";
        if (user.username === currentUsername) {
          dropdown.innerHTML = `
            <button class="user-dropdown-item" data-action="profile">내 프로필</button>
          `;
        } else {
          dropdown.innerHTML = `
            <button class="user-dropdown-item" data-action="profile">프로필 보기</button>
            <button class="user-dropdown-item" data-action="invite">게임 초대</button>
            <button class="user-dropdown-item" data-action="friend">친구 추가</button>
          `;
        }
        badge.appendChild(dropdown);

        // 닉네임 클릭 시 드롭다운 토글
        nicknameBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          // 다른 드롭다운 닫기
          document.querySelectorAll(".user-dropdown.active").forEach(d => {
            if (d !== dropdown) d.classList.remove("active");
          });
          dropdown.classList.toggle("active");
        });

        // 드롭다운 아이템 클릭 처리
        dropdown.addEventListener("click", (e) => {
          e.stopPropagation();
          const item = e.target.closest(".user-dropdown-item");
          if (!item) return;

          const action = item.dataset.action;
          const userId = nicknameBtn.dataset.userId;
          const username = nicknameBtn.dataset.username;
          const nickname = nicknameBtn.dataset.nickname;

          dropdown.classList.remove("active");

          if (action === "profile") {
            window.location.href = `/accounts/profile/${username}/`;
          } else if (action === "invite") {
            handleGameInvite(userId, nickname);
          } else if (action === "friend") {
            handleFriendRequest(userId, nickname);
          }
        });

        usersList.appendChild(badge);
      });

      // 외부 클릭 시 드롭다운 닫기
      document.addEventListener("click", () => {
        document.querySelectorAll(".user-dropdown.active").forEach(d => d.classList.remove("active"));
      });
    }

    // 게임 초대 처리
    function handleGameInvite(userId, nickname) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        if (window.showToast) {
          window.showToast("연결이 끊어졌습니다. 페이지를 새로고침 해주세요.", "error");
        }
        return;
      }
      ws.send(JSON.stringify({
        type: "game_invite",
        target_user_id: parseInt(userId),
      }));
      if (window.showToast) {
        window.showToast(`${nickname}님에게 게임 초대를 보냈습니다.`, "info");
      }
    }

    // 게임 초대 토스트 표시
    function showInviteToast(inviteId, fromNickname) {
      const toastContainer = document.getElementById("toast-container");
      if (!toastContainer) return;

      const toast = document.createElement("div");
      toast.className = "toast invite";
      toast.dataset.inviteId = inviteId;

      const inviteIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" fill="#b8860b"/>
        <path d="M12 6v6l4 2" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;

      toast.innerHTML = `
        <div class="toast-top">
          <span class="toast-icon">${inviteIcon}</span>
          <div class="toast-content">
            <div class="toast-message"><b>${fromNickname}</b>님이 게임에 초대했습니다.</div>
          </div>
          <button class="toast-close" onclick="respondToInvite('${inviteId}', false); this.closest('.toast').remove();">&times;</button>
        </div>
        <div class="invite-buttons">
          <button class="btn-invite-decline" onclick="respondToInvite('${inviteId}', false); this.closest('.toast').remove();">거절</button>
          <button class="btn-invite-accept" onclick="respondToInvite('${inviteId}', true); this.closest('.toast').remove();">수락</button>
        </div>
      `;

      toastContainer.appendChild(toast);

      // 60초 후 자동 거절
      setTimeout(() => {
        if (toast.parentElement) {
          respondToInvite(inviteId, false);
          toast.classList.add("slide-out");
          setTimeout(() => toast.remove(), 300);
        }
      }, 60000);
    }

    // 초대 응답 처리
    function respondToInvite(inviteId, accepted) {
      if (!inviteId) return;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: "invite_response",
          invite_id: inviteId,
          accepted: accepted,
        }));
      }
    }
    window.respondToInvite = respondToInvite;

    // 친구 추가 처리
    async function handleFriendRequest(userId, nickname) {
      try {
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]");
        if (!csrfToken) {
          if (window.showToast) window.showToast("인증 오류가 발생했습니다. 페이지를 새로고침 해주세요.", "error");
          return;
        }
        const response = await fetch(`/games/friends/request/${userId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken.value,
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        const result = await response.json();
        if (response.ok) {
          if (window.showToast) window.showToast(result.message || `${nickname}님에게 친구 요청을 보냈습니다.`, "success");
        } else {
          if (window.showToast) window.showToast(result.error || "친구 요청에 실패했습니다.", "error");
        }
      } catch (err) {
        console.error("Friend request error:", err);
        if (window.showToast) window.showToast("친구 요청 중 오류가 발생했습니다.", "error");
      }
    }

    // 초기 연결
    connect();
  })();

  // 모달 관리
  (function(){
    const newRoomBtn = document.getElementById("new-room-btn");
    const titleModal = document.getElementById("title-modal");
    const cancelBtn = document.getElementById("cancel-btn");
    const roomTitleInput = document.getElementById("room-title");

    if (newRoomBtn) {
      newRoomBtn.addEventListener("click", () => {
        titleModal.classList.add("active");
        setTimeout(() => roomTitleInput.focus(), 100);
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener("click", () => {
        titleModal.classList.remove("active");
        roomTitleInput.value = "";
      });
    }

    // 모달 외부 클릭 시 닫기
    titleModal.addEventListener("click", (e) => {
      if (e.target === titleModal) {
        titleModal.classList.remove("active");
        roomTitleInput.value = "";
      }
    });
  })();

  // AI 대전 모달 관리
  (function(){
    const aiGameBtn = document.getElementById("ai-game-btn");
    const aiModal = document.getElementById("ai-modal");
    const aiCancelBtn = document.getElementById("ai-cancel-btn");
    const aiStartBtn = document.getElementById("ai-start-btn");

    let selectedDifficulty = "normal";
    let selectedColor = "B";

    // 난이도/색상 버튼 클릭 처리
    aiModal.querySelectorAll(".option-btn[data-difficulty]").forEach(btn => {
      btn.addEventListener("click", () => {
        aiModal.querySelectorAll(".option-btn[data-difficulty]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedDifficulty = btn.dataset.difficulty;
      });
    });

    aiModal.querySelectorAll(".option-btn[data-color]").forEach(btn => {
      btn.addEventListener("click", () => {
        aiModal.querySelectorAll(".option-btn[data-color]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedColor = btn.dataset.color;
      });
    });

    if (aiGameBtn) {
      aiGameBtn.addEventListener("click", () => {
        aiModal.classList.add("active");
      });
    }

    if (aiCancelBtn) {
      aiCancelBtn.addEventListener("click", () => {
        aiModal.classList.remove("active");
      });
    }

    if (aiStartBtn) {
      aiStartBtn.addEventListener("click", () => {
        window.location.href = `{% url 'games:ai_game' %}?difficulty=${selectedDifficulty}&color=${selectedColor}`;
      });
    }

    // 모달 외부 클릭 시 닫기
    aiModal.addEventListener("click", (e) => {
      if (e.target === aiModal) {
        aiModal.classList.remove("active");
      }
    });
  })();

  // 랭킹 모달 관리
  (function(){
    const rankingBtn = document.getElementById("ranking-btn");
    const rankingModal = document.getElementById("ranking-modal");
    const rankingCloseBtn = document.getElementById("ranking-close-btn");

    if (rankingBtn) {
      rankingBtn.addEventListener("click", () => {
        rankingModal.classList.add("active");
      });
    }

    if (rankingCloseBtn) {
      rankingCloseBtn.addEventListener("click", () => {
        rankingModal.classList.remove("active");
      });
    }

    // 모달 외부 클릭 시 닫기
    rankingModal.addEventListener("click", (e) => {
      if (e.target === rankingModal) {
        rankingModal.classList.remove("active");
      }
    });

    // 랭킹 테이블의 티어 뱃지 초기화 (랭킹은 이미 5판 이상이므로 totalGames=999 기본값)
    document.querySelectorAll(".tier-slot[data-rating]").forEach(slot => {
      const rating = parseInt(slot.dataset.rating) || 1000;
      const totalGames = parseInt(slot.dataset.totalGames) || 999;  // 랭킹은 기본 5판 이상
      slot.innerHTML = getTierBadgeHTML(rating, totalGames);
    });

    // 내 닉네임 옆 티어 뱃지 초기화
    document.querySelectorAll(".my-tier-slot[data-rating]").forEach(slot => {
      const rating = parseInt(slot.dataset.rating) || 1000;
      const totalGames = parseInt(slot.dataset.totalGames) || 0;
      slot.innerHTML = getTierBadgeHTML(rating, totalGames);
    });
  })();

  // 티어 목록 모달 관리
  (function(){
    const tierListBtn = document.getElementById("tier-list-btn");
    const tierListModal = document.getElementById("tier-list-modal");
    const tierListCloseBtn = document.getElementById("tier-list-close-btn");

    if (tierListBtn) {
      tierListBtn.addEventListener("click", () => {
        tierListModal.classList.add("active");
      });
    }

    if (tierListCloseBtn) {
      tierListCloseBtn.addEventListener("click", () => {
        tierListModal.classList.remove("active");
      });
    }

    // 모달 외부 클릭 시 닫기
    tierListModal.addEventListener("click", (e) => {
      if (e.target === tierListModal) {
        tierListModal.classList.remove("active");
      }
    });
  })();

  // 채팅 관리
  (function(){
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("chat-send-btn");

    // 채팅 메시지 추가 함수
    window.addChatMessage = function(sender, message, isMine, rating = 1000, totalGames = 999, senderId = null, profileImage = null) {
      const messageDiv = document.createElement("div");
      messageDiv.className = isMine ? "chat-message mine" : "chat-message";

      // 프로필 이미지
      const profileImg = document.createElement("img");
      profileImg.className = "chat-profile-img";
      profileImg.src = profileImage || "/static/images/default_profile_green.svg";
      profileImg.alt = sender;

      const contentDiv = document.createElement("div");
      contentDiv.className = "chat-content";

      const senderSpan = document.createElement("div");
      senderSpan.className = "sender";

      // 티어 뱃지 + 닉네임 (5판 미만이면 "배치중" 표시)
      const tierBadgeSpan = document.createElement("span");
      tierBadgeSpan.innerHTML = getTierBadgeHTML(rating, totalGames);
      senderSpan.appendChild(tierBadgeSpan.firstChild);

      const nicknameSpan = document.createElement("span");
      nicknameSpan.className = "chat-nickname";
      nicknameSpan.textContent = sender;
      senderSpan.appendChild(nicknameSpan);

      const textDiv = document.createElement("div");
      textDiv.className = "text";
      textDiv.textContent = message;

      contentDiv.appendChild(senderSpan);
      contentDiv.appendChild(textDiv);

      messageDiv.appendChild(profileImg);
      messageDiv.appendChild(contentDiv);

      // 내 메시지가 아닌 경우 신고 버튼 추가
      if (!isMine && senderId) {
        const reportBtn = document.createElement("button");
        reportBtn.className = "report-btn";
        reportBtn.textContent = "신고";
        reportBtn.addEventListener("click", () => {
          openReportModal(senderId, sender, message);
        });
        messageDiv.appendChild(reportBtn);
      }

      chatMessages.appendChild(messageDiv);

      // 스크롤을 맨 아래로
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // 메시지 전송
    function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      if (window.lobbyWs && window.lobbyWs.readyState === WebSocket.OPEN) {
        window.lobbyWs.send(JSON.stringify({
          type: "chat_message",
          message: message
        }));
        chatInput.value = "";
      } else {
        alert("게임과 연결되지 않았습니다.");
      }
    }

    // 전송 버튼 클릭
    chatSendBtn.addEventListener("click", sendMessage);

    // Enter 키로 전송
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
  })();

  // 알림 WebSocket (DM 등 실시간 알림 수신)
  {% if user.is_authenticated %}
  (function(){
    const scheme = (location.protocol === "https:") ? "wss" : "ws";
    const notificationWsURL = `${scheme}://${location.host}/ws/notifications/`;

    let notificationWs = null;

    function connectNotification() {
      notificationWs = new WebSocket(notificationWsURL);

      notificationWs.addEventListener("open", () => {
        console.log("[Notification] WebSocket connected");
      });

      notificationWs.addEventListener("close", (e) => {
        console.log("[Notification] WebSocket closed:", e.code);
        // 5초 후 재연결
        setTimeout(connectNotification, 5000);
      });

      notificationWs.addEventListener("error", (e) => {
        console.error("[Notification] WebSocket error:", e);
      });

      // 알림음 재생 함수
      function playNotificationSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // 부드러운 알림음 설정
          oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
          oscillator.frequency.setValueAtTime(1100, audioContext.currentTime + 0.1); // C#6
          oscillator.type = "sine";

          // 볼륨 페이드 인/아웃
          gainNode.gain.setValueAtTime(0, audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
          gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        } catch (err) {
          console.debug("알림음 재생 실패:", err);
        }
      }

      notificationWs.addEventListener("message", (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === "dm_notification") {
            // DM 알림 토스트 표시
            const senderName = data.sender_name || "알 수 없음";
            const preview = data.message_preview || "";
            window.showToast(`${senderName}: ${preview}`, "info");

            // 알림음 재생
            playNotificationSound();

            // 친구 목록 뱃지 업데이트
            const friendBadge = document.getElementById("friendNotificationBadge");
            if (friendBadge) {
              const currentCount = parseInt(friendBadge.textContent) || 0;
              friendBadge.textContent = currentCount + 1;
              friendBadge.style.display = "inline";
            }
          }
        } catch (err) {
          console.error("[Notification] Message parse error:", err);
        }
      });
    }

    connectNotification();
  })();
  {% endif %}

  // 매칭 시스템 관리
  (function(){
    const matchmakingBtn = document.getElementById("matchmaking-btn");
    const searchModal = document.getElementById("matchmaking-search-modal");
    const matchFoundModal = document.getElementById("match-found-modal");
    const waitingAcceptModal = document.getElementById("waiting-accept-modal");

    const matchmakingTimer = document.getElementById("matchmaking-timer");
    const ratingRange = document.getElementById("rating-range");
    const matchmakingCancelBtn = document.getElementById("matchmaking-cancel-btn");

    const opponentTier = document.getElementById("opponent-tier");
    const opponentNickname = document.getElementById("opponent-nickname");
    const opponentRating = document.getElementById("opponent-rating");
    const countdownBar = document.getElementById("countdown-bar");
    const acceptCountdown = document.getElementById("accept-countdown");
    const matchAcceptBtn = document.getElementById("match-accept-btn");
    const matchDeclineBtn = document.getElementById("match-decline-btn");

    const waitingCancelBtn = document.getElementById("waiting-cancel-btn");

    let matchmakingWs = null;
    let currentMatchId = null;
    let acceptCountdownInterval = null;
    let acceptTimeLeft = 10;
    let myRating = 1000;  // 내 RP (매칭 큐 진입 시 업데이트)

    if (!matchmakingBtn) return;

    // 매칭 WebSocket 연결
    function connectMatchmaking() {
      const scheme = (location.protocol === "https:") ? "wss" : "ws";
      const wsURL = `${scheme}://${location.host}/ws/matchmaking/`;

      matchmakingWs = new WebSocket(wsURL);

      matchmakingWs.addEventListener("open", () => {
        console.log("[Matchmaking] WebSocket connected");
        // 큐에 참가
        matchmakingWs.send(JSON.stringify({ type: "join_queue" }));
      });

      matchmakingWs.addEventListener("close", (e) => {
        console.log("[Matchmaking] WebSocket closed:", e.code);
        hideAllModals();
      });

      matchmakingWs.addEventListener("error", (e) => {
        console.error("[Matchmaking] WebSocket error:", e);
        hideAllModals();
        window.showToast("매칭 서버 연결에 실패했습니다.", "error");
      });

      matchmakingWs.addEventListener("message", (e) => {
        try {
          const data = JSON.parse(e.data);
          handleMatchmakingMessage(data);
        } catch (err) {
          console.error("[Matchmaking] Message parse error:", err);
        }
      });
    }

    // 메시지 핸들러
    function handleMatchmakingMessage(data) {
      console.log("[Matchmaking] Received:", data);

      switch (data.type) {
        case "queue_joined":
          // 큐 진입 성공
          myRating = data.rating || 1000;  // 내 RP 저장
          searchModal.classList.add("active");
          break;

        case "queue_update":
          // 타이머 업데이트
          updateTimer(data.elapsed_seconds);
          // 티어 범위로 표시 (예: "3급 ~ 2급")
          ratingRange.textContent = getTierRangeDisplay(myRating, data.current_range);
          break;

        case "match_found":
          // 매칭 성공!
          currentMatchId = data.match_id;
          if (window.bgmManager) window.bgmManager.switchToMatchFound();
          showMatchFound(data.opponent, data.accept_timeout);
          break;

        case "match_status":
          // 상대방 수락 대기
          if (data.status === "waiting") {
            matchFoundModal.classList.remove("active");
            waitingAcceptModal.classList.add("active");
          }
          break;

        case "match_confirmed":
          // 양쪽 수락 - 게임 시작
          hideAllModals();
          if (window.bgmManager) window.bgmManager.stopAll();
          window.showToast("매칭 성공! 게임을 시작합니다.", "success");
          // 게임 페이지로 이동
          setTimeout(() => {
            window.location.href = `/games/${data.game_id}/`;
          }, 500);
          break;

        case "match_declined":
          // 매칭 거절됨
          hideAllModals();
          if (data.reason === "opponent_declined") {
            if (window.bgmManager) window.bgmManager.switchToMatchmaking();
            window.showToast("상대방이 매칭을 거절했습니다. 다시 검색합니다.", "info");
            // 다시 검색 모달 표시
            searchModal.classList.add("active");
          } else {
            if (window.bgmManager) window.bgmManager.switchToLobby();
            window.showToast("매칭을 취소했습니다.", "info");
          }
          break;

        case "match_timeout":
          // 수락 시간 초과
          hideAllModals();
          if (window.bgmManager) window.bgmManager.switchToLobby();
          window.showToast("수락 시간이 초과되었습니다.", "error");
          break;

        case "queue_left":
          // 큐 이탈
          hideAllModals();
          break;

        case "error":
          // 에러
          hideAllModals();
          if (window.bgmManager) window.bgmManager.switchToLobby();
          window.showToast(data.message || "오류가 발생했습니다.", "error");
          break;
      }
    }

    // 타이머 업데이트
    function updateTimer(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      matchmakingTimer.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // 매칭 성공 표시
    function showMatchFound(opponent, timeout) {
      searchModal.classList.remove("active");
      matchFoundModal.classList.add("active");

      // 상대방 티어 뱃지 표시 (5판 미만이면 "배치중")
      opponentTier.innerHTML = getTierBadgeHTML(opponent.rating, opponent.total_games || 0);
      opponentNickname.textContent = opponent.nickname;
      opponentRating.textContent = opponent.rating;

      // 상대방 프로필 이미지
      const opponentProfileImg = document.getElementById("opponent-profile-img");
      if (opponentProfileImg) {
        opponentProfileImg.src = opponent.profile_image || "/static/images/default_profile_green.svg";
      }

      // 수락 카운트다운 시작
      acceptTimeLeft = timeout;
      acceptCountdown.textContent = acceptTimeLeft;
      countdownBar.style.width = "100%";

      if (acceptCountdownInterval) {
        clearInterval(acceptCountdownInterval);
      }

      acceptCountdownInterval = setInterval(() => {
        acceptTimeLeft--;
        acceptCountdown.textContent = acceptTimeLeft;
        countdownBar.style.width = `${(acceptTimeLeft / timeout) * 100}%`;

        if (acceptTimeLeft <= 0) {
          clearInterval(acceptCountdownInterval);
          // 시간 초과 - 자동 거절
          if (matchmakingWs && matchmakingWs.readyState === WebSocket.OPEN) {
            matchmakingWs.send(JSON.stringify({
              type: "decline_match",
              match_id: currentMatchId
            }));
          }
        }
      }, 1000);
    }

    // 모든 모달 숨기기
    function hideAllModals() {
      searchModal.classList.remove("active");
      matchFoundModal.classList.remove("active");
      waitingAcceptModal.classList.remove("active");

      if (acceptCountdownInterval) {
        clearInterval(acceptCountdownInterval);
        acceptCountdownInterval = null;
      }

      currentMatchId = null;
    }

    // 매칭 종료
    function endMatchmaking() {
      if (matchmakingWs) {
        if (matchmakingWs.readyState === WebSocket.OPEN) {
          matchmakingWs.send(JSON.stringify({ type: "leave_queue" }));
        }
        matchmakingWs.close();
        matchmakingWs = null;
      }
      hideAllModals();
    }

    // 이벤트 리스너
    matchmakingBtn.addEventListener("click", () => {
      connectMatchmaking();
      if (window.bgmManager) window.bgmManager.switchToMatchmaking();
    });

    matchmakingCancelBtn.addEventListener("click", () => {
      endMatchmaking();
      if (window.bgmManager) window.bgmManager.switchToLobby();
    });

    matchAcceptBtn.addEventListener("click", () => {
      if (matchmakingWs && matchmakingWs.readyState === WebSocket.OPEN && currentMatchId) {
        matchmakingWs.send(JSON.stringify({
          type: "accept_match",
          match_id: currentMatchId
        }));

        // 수락 후 대기 모달 표시
        if (acceptCountdownInterval) {
          clearInterval(acceptCountdownInterval);
        }
        matchFoundModal.classList.remove("active");
        waitingAcceptModal.classList.add("active");
      }
    });

    matchDeclineBtn.addEventListener("click", () => {
      if (matchmakingWs && matchmakingWs.readyState === WebSocket.OPEN && currentMatchId) {
        matchmakingWs.send(JSON.stringify({
          type: "decline_match",
          match_id: currentMatchId
        }));
      }
    });

    waitingCancelBtn.addEventListener("click", () => {
      if (matchmakingWs && matchmakingWs.readyState === WebSocket.OPEN && currentMatchId) {
        matchmakingWs.send(JSON.stringify({
          type: "decline_match",
          match_id: currentMatchId
        }));
      }
    });

    // 모달 외부 클릭 시 닫기 (검색 모달만)
    searchModal.addEventListener("click", (e) => {
      if (e.target === searchModal) {
        endMatchmaking();
      }
    });
  })();

  // 채팅 토글 관리 (모바일용)
  (function(){
    const chatContainer = document.getElementById("chat-container");
    const chatToggleBtn = document.getElementById("chat-toggle-btn");
    const chatCloseBtn = document.getElementById("chat-close-btn");

    let userManuallyOpened = false; // 사용자가 수동으로 열었는지 추적

    // 초기 상태 설정 (데스크톱에서는 열림, 모바일에서는 닫힘)
    function initChatState() {
      if (window.innerWidth <= 768) {
        // 모바일: 사용자가 수동으로 열지 않았으면 닫힌 상태
        if (!userManuallyOpened) {
          chatContainer.classList.add("hidden");
        }
      } else {
        // 데스크톱: 항상 열린 상태
        chatContainer.classList.remove("hidden");
        userManuallyOpened = false; // 데스크톱에서는 플래그 리셋
      }
    }

    // 초기 상태 설정
    initChatState();

    // 화면 크기 변경 시 상태 업데이트 (debounce로 키보드 올라올 때 방지)
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        // 너비 변경이 클 때만 실행 (키보드로 인한 높이 변경은 무시)
        initChatState();
      }, 200);
    });

    // 토글 버튼 클릭 (모바일에서 채팅 열기)
    chatToggleBtn.addEventListener("click", () => {
      chatContainer.classList.remove("hidden");
      userManuallyOpened = true; // 사용자가 수동으로 열었음을 표시
    });

    // 닫기 버튼 클릭 (모바일에서 채팅 닫기)
    chatCloseBtn.addEventListener("click", () => {
      chatContainer.classList.add("hidden");
      userManuallyOpened = false; // 플래그 리셋
    });
  })();

  // 랭킹 탭 전환 관리
  (function(){
    const rankingTabs = document.querySelectorAll(".ranking-tab");
    const rankingContents = document.querySelectorAll(".ranking-content");

    rankingTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const targetTab = tab.dataset.tab;

        // 모든 탭 비활성화
        rankingTabs.forEach(t => t.classList.remove("active"));
        // 클릭한 탭 활성화
        tab.classList.add("active");

        // 모든 컨텐츠 숨기기
        rankingContents.forEach(content => content.classList.add("hidden"));
        // 선택한 컨텐츠 표시
        const targetContent = document.getElementById(`ranking-${targetTab}`);
        if (targetContent) {
          targetContent.classList.remove("hidden");
        }
      });
    });
  })();

  // 비밀번호 모달 관리
  (function(){
    const passwordModal = document.getElementById("password-modal");
    const passwordForm = document.getElementById("password-form");
    const passwordCancelBtn = document.getElementById("password-cancel-btn");
    const gamePasswordInput = document.getElementById("game-password");
    const roomCards = document.querySelectorAll(".room-card");

    let selectedGameId = null;
    let selectedGameUrl = null;

    // 방 카드 클릭 이벤트
    roomCards.forEach(card => {
      card.addEventListener("click", (e) => {
        // 닉네임 링크 클릭 시 이벤트 전파 방지 확인
        if (e.target.classList.contains('nickname-link')) {
          return;
        }

        const hasPassword = card.dataset.hasPassword === "true";
        selectedGameId = card.dataset.gameId;
        selectedGameUrl = card.dataset.gameUrl;

        if (hasPassword) {
          // 비밀번호가 있으면 모달 표시
          passwordModal.classList.add("active");
          setTimeout(() => gamePasswordInput.focus(), 100);
        } else {
          // 비밀번호가 없으면 바로 이동
          window.location.href = selectedGameUrl;
        }
      });
    });

    // 비밀번호 form submit
    passwordForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const password = gamePasswordInput.value;

      if (!password) {
        alert("비밀번호를 입력하세요.");
        return;
      }

      // 게임 URL 가져오기 (동적 방 카드에서 설정된 경우 dataset 사용)
      const gameUrl = selectedGameUrl || passwordForm.dataset.gameUrl;
      if (!gameUrl) {
        alert("게임을 선택해주세요.");
        return;
      }

      // 비밀번호와 함께 POST 요청
      const formData = new FormData();
      formData.append("password", password);
      formData.append("csrfmiddlewaretoken", document.querySelector('[name=csrfmiddlewaretoken]').value);

      try {
        const response = await fetch(gameUrl, {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          // 성공하면 리다이렉트
          window.location.href = response.url;
        } else {
          // 비밀번호가 틀리면 경고
          alert("비밀번호가 틀렸습니다.");
          gamePasswordInput.value = "";
          gamePasswordInput.focus();
        }
      } catch (err) {
        console.error("비밀번호 확인 오류:", err);
        alert("오류가 발생했습니다. 다시 시도해주세요.");
      }
    });

    // 취소 버튼
    passwordCancelBtn.addEventListener("click", () => {
      passwordModal.classList.remove("active");
      gamePasswordInput.value = "";
      selectedGameId = null;
      selectedGameUrl = null;
    });

    // 모달 외부 클릭 시 닫기
    passwordModal.addEventListener("click", (e) => {
      if (e.target === passwordModal) {
        passwordModal.classList.remove("active");
        gamePasswordInput.value = "";
        selectedGameId = null;
        selectedGameUrl = null;
      }
    });
  })();

  // 친구 알림 체크
  (function(){
    const friendNotificationBadge = document.getElementById("friendNotificationBadge");

    async function checkUnreadMessages() {
      try {
        const response = await fetch("{% url 'games:unread_message_count' %}");
        const data = await response.json();

        if (data.unread_count > 0) {
          friendNotificationBadge.textContent = data.unread_count;
          friendNotificationBadge.style.display = "inline";
        } else {
          friendNotificationBadge.style.display = "none";
        }
      } catch (err) {
        console.error("친구 알림 확인 오류:", err);
      }
    }

    // 초기 체크 및 30초마다 체크
    checkUnreadMessages();
    setInterval(checkUnreadMessages, 30000);
  })();
  </script>

  <!-- 신고 모달 -->
  <div class="report-modal" id="report-modal">
    <div class="report-content">
      <h3>유저 신고</h3>
      <div class="report-target" id="report-target-info"></div>
      <label for="report-reason">신고 사유</label>
      <select id="report-reason">
        <option value="">선택하세요</option>
        <option value="abuse">욕설/비하</option>
        <option value="spam">도배/스팸</option>
        <option value="inappropriate">부적절한 행동</option>
        <option value="other">기타</option>
      </select>
      <label for="report-description">상세 설명 (선택)</label>
      <textarea id="report-description" placeholder="추가 설명이 있다면 입력해주세요..."></textarea>
      <div class="report-actions">
        <button class="btn-report-cancel" id="report-cancel-btn">취소</button>
        <button class="btn-report-submit" id="report-submit-btn">신고</button>
      </div>
    </div>
  </div>

  <script>
  // 신고 모달 로직
  (function(){
    const reportModal = document.getElementById("report-modal");
    const reportReason = document.getElementById("report-reason");
    const reportDescription = document.getElementById("report-description");
    const reportTargetInfo = document.getElementById("report-target-info");
    const reportCancelBtn = document.getElementById("report-cancel-btn");
    const reportSubmitBtn = document.getElementById("report-submit-btn");

    let reportUserId = null;
    let reportEvidence = "";

    window.openReportModal = function(userId, nickname, chatMessage) {
      if (!reportModal) {
        console.error("신고 모달을 찾을 수 없습니다.");
        if (window.showToast) window.showToast("신고 기능을 사용할 수 없습니다.", "error");
        return;
      }
      reportUserId = userId;
      reportEvidence = chatMessage || "";
      if (reportTargetInfo) reportTargetInfo.textContent = `대상: ${nickname}`;
      if (reportReason) reportReason.value = "";
      if (reportDescription) reportDescription.value = "";
      reportModal.classList.add("active");
    };

    if (reportCancelBtn) {
      reportCancelBtn.addEventListener("click", () => {
        reportModal.classList.remove("active");
        reportUserId = null;
      });
    }

    if (reportModal) {
      reportModal.addEventListener("click", (e) => {
        if (e.target === reportModal) {
          reportModal.classList.remove("active");
          reportUserId = null;
        }
      });
    }

    if (reportSubmitBtn) reportSubmitBtn.addEventListener("click", async () => {
      if (!reportReason.value) {
        if (window.showToast) {
          window.showToast("신고 사유를 선택해주세요.", "error");
        }
        return;
      }

      reportSubmitBtn.disabled = true;
      reportSubmitBtn.textContent = "접수 중...";

      try {
        const response = await fetch("{% url 'games:submit_report' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
          },
          body: JSON.stringify({
            reported_user_id: reportUserId,
            report_type: "chat",
            reason: reportReason.value,
            description: reportDescription.value,
            evidence: reportEvidence,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          if (window.showToast) window.showToast(result.message, "success");
        } else {
          if (window.showToast) window.showToast(result.error, "error");
        }
      } catch (err) {
        console.error("신고 오류:", err);
        if (window.showToast) window.showToast("신고 접수 중 오류가 발생했습니다.", "error");
      } finally {
        reportSubmitBtn.disabled = false;
        reportSubmitBtn.textContent = "신고";
        reportModal.classList.remove("active");
        reportUserId = null;
      }
    });
  })();
  </script>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Toast Notification Script -->
  <script>
  (function(){
    {% if messages %}
      const toastContainer = document.getElementById('toast-container');
      const messages = [
        {% for message in messages %}
          {
            type: '{{ message.tags }}',
            text: '{{ message|escapejs }}'
          },
        {% endfor %}
      ];

      messages.forEach((msg, index) => {
        setTimeout(() => showToast(msg.text, msg.type), index * 300);
      });
    {% endif %}

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#4a7c59"/>
          <path d="M7 12l3 3 7-7" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`,
        error: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#c53030"/>
          <path d="M8 8l8 8M16 8l-8 8" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>`,
        info: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#4a7c89"/>
          <path d="M12 11v6M12 7v1" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>`
      };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <div class="toast-content">
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
      `;

      toastContainer.appendChild(toast);

      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        toast.classList.add('slide-out');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Make showToast globally available for WebSocket messages
    window.showToast = showToast;
  })();
  </script>

  <!-- Service Worker 등록 -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/sw.js')
      .then(reg => {
        console.log('[SW] Service Worker 등록 성공:', reg.scope);
      })
      .catch(err => {
        console.log('[SW] Service Worker 등록 실패:', err);
      });
  }
  </script>

  <!-- 푸터 -->
  <footer style="margin-top: 3rem; padding: 2rem 0; text-align: center; border-top: 1px solid rgba(123, 92, 58, 0.3);">
    <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
      <a href="{% url 'accounts:privacy_policy' %}" style="color: var(--border); text-decoration: none; font-size: 0.9rem; font-weight: 500;">개인정보처리방침</a>
      <a href="{% url 'accounts:terms_of_service' %}" style="color: var(--border); text-decoration: none; font-size: 0.9rem; font-weight: 500;">서비스 이용약관</a>
    </div>
    <p style="margin: 0; color: #666; font-size: 0.85rem;">© 2026 오목조목. All rights reserved.</p>
  </footer>

<script>
  // 다크모드 토글
  (function() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeToggleMobile = document.getElementById('theme-toggle-mobile');
    const html = document.documentElement;

    // 저장된 테마 불러오기
    const savedTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    updateText(savedTheme);

    function toggleTheme() {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateText(newTheme);
    }

    if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
    if (themeToggleMobile) themeToggleMobile.addEventListener('click', toggleTheme);

    function updateText(theme) {
      const text = theme === 'dark' ? '라이트모드' : '다크모드';
      if (themeToggle) themeToggle.textContent = text;
      if (themeToggleMobile) themeToggleMobile.textContent = text;
    }
  })();
</script>

<!-- BGM & Settings Script -->
<script>
(function() {
  // ── Audio Elements ──
  const bgmLobby = document.getElementById('bgm-lobby');
  const bgmMatchmaking = document.getElementById('bgm-matchmaking');
  const bgmMatchFound = document.getElementById('bgm-match-found');

  // ── Settings Elements ──
  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const settingsCloseBtn = document.getElementById('settings-close-btn');
  const bgmToggle = document.getElementById('bgm-toggle');
  const bgmVolumeSlider = document.getElementById('bgm-volume');
  const bgmVolumeValue = document.getElementById('bgm-volume-value');
  const sfxToggle = document.getElementById('sfx-toggle');
  const sfxVolumeSlider = document.getElementById('sfx-volume');
  const sfxVolumeValue = document.getElementById('sfx-volume-value');

  // ── State ──
  let bgmEnabled = localStorage.getItem('bgm-enabled') !== 'false';
  let bgmVolume = parseFloat(localStorage.getItem('bgm-volume') || '0.3');
  let sfxEnabled = localStorage.getItem('sfx-enabled') !== 'false';
  let sfxVolume = parseFloat(localStorage.getItem('sfx-volume') || '0.5');
  let currentBgm = null;       // currently playing audio element
  let userInteracted = false;  // autoplay policy guard
  let fadeInterval = null;

  // ── Init UI ──
  bgmToggle.checked = bgmEnabled;
  bgmVolumeSlider.value = Math.round(bgmVolume * 100);
  bgmVolumeValue.textContent = Math.round(bgmVolume * 100) + '%';
  sfxToggle.checked = sfxEnabled;
  sfxVolumeSlider.value = Math.round(sfxVolume * 100);
  sfxVolumeValue.textContent = Math.round(sfxVolume * 100) + '%';

  // ── Settings Modal ──
  settingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('active');
  });
  settingsCloseBtn.addEventListener('click', () => {
    settingsModal.classList.remove('active');
  });
  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) settingsModal.classList.remove('active');
  });

  // ── Settings Handlers ──
  bgmToggle.addEventListener('change', () => {
    bgmEnabled = bgmToggle.checked;
    localStorage.setItem('bgm-enabled', bgmEnabled);
    if (bgmEnabled && currentBgm) {
      currentBgm.volume = bgmVolume;
      currentBgm.play().catch(() => {});
    } else if (!bgmEnabled && currentBgm) {
      currentBgm.pause();
    }
  });

  bgmVolumeSlider.addEventListener('input', () => {
    bgmVolume = parseInt(bgmVolumeSlider.value) / 100;
    bgmVolumeValue.textContent = bgmVolumeSlider.value + '%';
    localStorage.setItem('bgm-volume', bgmVolume);
    if (currentBgm && bgmEnabled) {
      currentBgm.volume = bgmVolume;
    }
  });

  sfxToggle.addEventListener('change', () => {
    sfxEnabled = sfxToggle.checked;
    localStorage.setItem('sfx-enabled', sfxEnabled);
  });

  sfxVolumeSlider.addEventListener('input', () => {
    sfxVolume = parseInt(sfxVolumeSlider.value) / 100;
    sfxVolumeValue.textContent = sfxVolumeSlider.value + '%';
    localStorage.setItem('sfx-volume', sfxVolume);
  });

  // ── Core BGM Functions ──
  function playBgm(audioEl) {
    if (!bgmEnabled) {
      currentBgm = audioEl;
      return;
    }
    if (currentBgm === audioEl && !audioEl.paused) return;

    audioEl.volume = bgmVolume;
    audioEl.currentTime = 0;
    audioEl.play().catch(() => {});
    currentBgm = audioEl;
  }

  function stopBgm(audioEl) {
    if (!audioEl) return;
    audioEl.pause();
    audioEl.currentTime = 0;
  }

  function crossFade(fromAudio, toAudio, duration) {
    duration = duration || 800;
    if (fadeInterval) clearInterval(fadeInterval);

    const steps = 20;
    const stepTime = duration / steps;
    let step = 0;
    const fromVol = fromAudio ? fromAudio.volume : 0;

    if (toAudio) {
      toAudio.volume = 0;
      toAudio.currentTime = 0;
      if (bgmEnabled) toAudio.play().catch(() => {});
    }

    fadeInterval = setInterval(() => {
      step++;
      const progress = step / steps;

      if (fromAudio) {
        fromAudio.volume = Math.max(0, fromVol * (1 - progress));
      }
      if (toAudio && bgmEnabled) {
        toAudio.volume = bgmVolume * progress;
      }

      if (step >= steps) {
        clearInterval(fadeInterval);
        fadeInterval = null;
        if (fromAudio) {
          fromAudio.pause();
          fromAudio.currentTime = 0;
        }
        currentBgm = toAudio;
      }
    }, stepTime);
  }

  // ── Autoplay Policy ──
  // 이전 페이지에서 이미 인터랙션했으면 바로 재생
  if (sessionStorage.getItem('bgm-interacted')) {
    userInteracted = true;
    playBgm(bgmLobby);
  } else {
    function onFirstInteraction() {
      if (userInteracted) return;
      userInteracted = true;
      sessionStorage.setItem('bgm-interacted', '1');
      playBgm(bgmLobby);
      document.removeEventListener('click', onFirstInteraction);
      document.removeEventListener('touchstart', onFirstInteraction);
      document.removeEventListener('keydown', onFirstInteraction);
    }
    document.addEventListener('click', onFirstInteraction);
    document.addEventListener('touchstart', onFirstInteraction);
    document.addEventListener('keydown', onFirstInteraction);
  }

  // ── Expose BGM API for matchmaking integration ──
  window.bgmManager = {
    switchToMatchmaking: function() {
      crossFade(currentBgm, bgmMatchmaking, 800);
    },
    switchToMatchFound: function() {
      crossFade(currentBgm, bgmMatchFound, 500);
    },
    switchToLobby: function() {
      crossFade(currentBgm, bgmLobby, 800);
    },
    stopAll: function() {
      if (fadeInterval) { clearInterval(fadeInterval); fadeInterval = null; }
      stopBgm(bgmLobby);
      stopBgm(bgmMatchmaking);
      stopBgm(bgmMatchFound);
      currentBgm = null;
    }
  };
})();
</script>

{% include "includes/heartbeat.html" %}
</body>
</html>
