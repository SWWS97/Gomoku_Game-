<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Omok {{ game.id }}</title>
  <style>
    :root{
      --cell: 40px;
      --margin: 28px;
      --wood: #d4b781;
      --line: #7b5c3a;
      --border: #3e2a1f;
    }

    html, body { height:100%; margin:0; background:#faf7f2;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, sans-serif; }

    /* ===== Top bar ===== */
    .topbar{
      display:flex; align-items:center; gap:14px;
      padding:12px 16px 6px; font-weight:700;
    }
    .topbar .right{ margin-left:auto; display:flex; gap:14px; align-items:center; }
    .pill{ padding:.35rem .6rem; border:1px solid #b08f66; border-radius:.5rem; background:#fff; cursor:pointer; }
    .players{ display:flex; gap:16px; }
    .player-info{ padding:.4rem .7rem; border:1px solid #ccc; border-radius:.4rem; background:#fff; font-size:.9rem; }
    .player-info .label{ color:#666; font-size:.8rem; }

    /* ===== íƒ€ì´ë¨¸ (ìƒë‹¨ ì¤‘ì•™) ===== */
    .timer-container{
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 40px;
      background: rgba(255,255,255,0.95);
      padding: 1rem 2rem;
      border-radius: 0.8rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 2px solid #d4b781;
      z-index: 10;
    }
    .timer-item{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }
    .timer-label{
      font-size: 0.85rem;
      color: #666;
      font-weight: 600;
    }
    .timer-value{
      font-size: 1.8rem;
      font-weight: 900;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.05em;
    }
    .timer-value.black{ color: #2b2b2b; }
    .timer-value.white{ color: #5a5a5a; }
    .timer-value.active{
      color: #d84315;
      animation: timerPulse 1s ease-in-out infinite;
    }
    .timer-value.warning{
      color: #d84315 !important;
    }
    @keyframes timerPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ìŠ¹ì ë°°ì§€(ìƒë‹¨ í‘œì‹œ) */
    .winner-badge{
      display:none;  /* ê¸°ë³¸ ìˆ¨ê¹€, ìŠ¹ì ë‚˜ì˜¤ë©´ ë³´ì—¬ì¤Œ */
      padding:.25rem .55rem;
      border-radius:.6rem;
      border:1px solid #d5b2a8;
      background:#fff4ef;
      color:#7a2e2e;
      font-weight:800;
      font-size:1.12rem;  /* ìš”ì²­: ì‚´ì§ í¬ê²Œ */
      box-shadow: 0 1px 0 rgba(255,255,255,.6) inset;
    }

    /* ===== ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ ===== */
    .game-over-modal{
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.6);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal-content{
      background:#fff;
      padding:2.5rem 3rem;
      border-radius:1rem;
      box-shadow:0 10px 40px rgba(0,0,0,0.3);
      text-align:center;
      max-width:400px;
      animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
      from { opacity:0; transform:translateY(-20px); }
      to { opacity:1; transform:translateY(0); }
    }
    .modal-content h2{
      margin:0 0 1rem;
      font-size:1.8rem;
      color:#7a2e2e;
    }
    .modal-content .winner-name{
      font-size:2.2rem;
      font-weight:900;
      margin:1rem 0;
      color:#2b2b2b;
    }
    .modal-content .winner-stone{
      font-size:3rem;
      margin:0.5rem 0;
    }
    .modal-content .modal-btn{
      margin-top:1.5rem;
      padding:0.75rem 2rem;
      background:#7a2e2e;
      color:#fff;
      border:none;
      border-radius:0.5rem;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:background 0.2s;
    }
    .modal-content .modal-btn:hover{
      background:#5a1e1e;
    }

    /* ===== Board ===== */
    .board-wrap{
      position:relative;
      width: calc(({{ BOARD_SIZE }} - 1) * var(--cell) + 2 * var(--margin));
      height: calc(({{ BOARD_SIZE }} - 1) * var(--cell) + 2 * var(--margin));
      margin: 10px auto 36px;
      border: 6px solid var(--border);
      background: var(--wood);
      border-radius: 6px;
      box-shadow: 0 18px 26px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
      overflow: visible;
    }
    .grid{ position:absolute; inset:0; display:block; }
    .layer{ position:absolute; inset:0; pointer-events:none; }

    .pt{
      position:absolute; width:var(--cell); height:var(--cell);
      transform: translate(-50%, -50%);
      pointer-events:auto; background:transparent; border:none; padding:0; cursor:pointer;
    }
    .pt:hover::after{
      content:""; position:absolute; left:50%; top:50%;
      width:18px; height:18px; transform:translate(-50%,-50%);
      border-radius:50%;
      background: radial-gradient(circle at 35% 35%, rgba(0,0,0,.18), rgba(0,0,0,0) 60%);
    }

    .stone{
      position:absolute; width:28px; height:28px; transform:translate(-50%,-50%); border-radius:50%;
      pointer-events:none; filter: drop-shadow(0 3px 3px rgba(0,0,0,.35));
    }
    .stone.black{
      background:
        radial-gradient(circle at 30% 28%, #4a4a4a 0%, #262626 45%, #0f0f0f 70%),
        radial-gradient(circle at 68% 74%, rgba(255,255,255,.20), rgba(255,255,255,0) 55%);
      box-shadow: inset 1px 1px 3px rgba(255,255,255,.08), inset -7px -7px 12px rgba(0,0,0,.55);
    }
    .stone.white{
      background:
        radial-gradient(circle at 30% 28%, #ffffff 0%, #f1f1f1 45%, #e7e7e7 70%),
        radial-gradient(circle at 68% 78%, rgba(0,0,0,.12), rgba(0,0,0,0) 55%);
      box-shadow: inset 1px 1px 2px rgba(255,255,255,.75), inset -7px -7px 12px rgba(0,0,0,.12);
    }

    /* ë§ˆì§€ë§‰ ì°©ìˆ˜ ê°•ì¡° ì• ë‹ˆë©”ì´ì…˜ */
    .stone.last-move {
      animation: stonePulse 1.5s ease-in-out 3;
    }
    @keyframes stonePulse {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
        filter: drop-shadow(0 3px 3px rgba(0,0,0,.35));
      }
      50% {
        transform: translate(-50%, -50%) scale(1.15);
        filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.8)) drop-shadow(0 3px 3px rgba(0,0,0,.35));
      }
    }

    /* í•˜ë‹¨ ìƒíƒœ(ì´ì œ ì‚¬ìš© ì•ˆ í•¨, í˜¹ì‹œ ëª°ë¼ ë‚¨ê²¨ë‘ ) */
    .status{ margin:8px 0 0 16px; font-weight:600; }
    .status .winner{ color:#7a2e2e; margin-left:10px; display:none; }

    /* ===== ë¦¬ë§¤ì¹˜ ëŒ€ê¸° ì  ì• ë‹ˆë©”ì´ì…˜ ===== */
    .dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 25% { content: '.'; }
      26%, 50% { content: '..'; }
      51%, 75% { content: '...'; }
      76%, 100% { content: ''; }
    }

    /* ===== ë¦¬ë§¤ì¹˜ ì•„ì´ì½˜ ë””ìì¸ ===== */
    /* íšŒì „í•˜ëŠ” ì›í˜• í™”ì‚´í‘œ (ë¦¬ë§¤ì¹˜ ìš”ì²­) */
    .rematch-icon {
      width: 80px;
      height: 80px;
      position: relative;
      margin: 1rem auto;
    }
    .rematch-icon .circle-arrow {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 4px solid #4a7c59;
      border-radius: 50%;
      border-top-color: transparent;
      border-right-color: transparent;
      animation: rotateArrow 1.5s ease-in-out infinite;
    }
    .rematch-icon .circle-arrow:nth-child(2) {
      transform: rotate(180deg);
      animation-delay: -0.75s;
    }
    .rematch-icon::before,
    .rematch-icon::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }
    .rematch-icon::before {
      top: -2px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      border-width: 0 8px 8px 0;
      border-color: transparent #4a7c59 transparent transparent;
    }
    .rematch-icon::after {
      bottom: -2px;
      right: 50%;
      transform: translateX(50%) rotate(-135deg);
      border-width: 0 8px 8px 0;
      border-color: transparent #4a7c59 transparent transparent;
    }
    @keyframes rotateArrow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ (ë¦¬ë§¤ì¹˜ ëŒ€ê¸°) */
    .loading-spinner {
      width: 70px;
      height: 70px;
      position: relative;
      margin: 1rem auto;
    }
    .loading-spinner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 5px solid #e0e0e0;
      border-radius: 50%;
      border-top-color: #4a7c59;
      border-right-color: #4a7c59;
      animation: spin 1.2s linear infinite;
    }
    .loading-spinner::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 45px;
      height: 45px;
      margin: -22.5px 0 0 -22.5px;
      border: 4px solid #f5f5f5;
      border-radius: 50%;
      border-bottom-color: #6b9477;
      border-left-color: #6b9477;
      animation: spin 1.8s linear infinite reverse;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== ëª¨ë°”ì¼ ë°˜ì‘í˜• ===== */
    @media (max-width: 768px) {
      /* ìƒë‹¨ ë°” */
      .topbar{
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      .topbar .right{
        width: 100%;
        justify-content: flex-start;
        gap: 8px;
        margin-top: 8px;
      }
      .pill{
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
      }
      .players{
        gap: 8px;
        flex-wrap: wrap;
      }
      .player-info{
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
      }

      /* íƒ€ì´ë¨¸ */
      .timer-container{
        top: 10px;
        gap: 20px;
        padding: 0.5rem 1rem;
      }
      .timer-label{
        font-size: 0.7rem;
      }
      .timer-value{
        font-size: 1.2rem;
      }

      /* ìŠ¹ì ë°°ì§€ */
      .winner-badge{
        font-size: 0.9rem;
        padding: 0.2rem 0.4rem;
      }

      /* ê²Œì„íŒ */
      .board-wrap{
        width: calc(95vw - 24px);
        max-width: 500px;
        height: calc(95vw - 24px);
        max-height: 500px;
        margin: 60px auto 20px;
        border: 4px solid var(--border);
      }

      /* ëª¨ë‹¬ */
      .modal-content{
        padding: 1.5rem 2rem;
        max-width: 90%;
      }
      .modal-content h2{
        font-size: 1.4rem;
      }
      .modal-content .winner-name{
        font-size: 1.8rem;
      }
      .modal-content .winner-stone{
        font-size: 2.5rem;
      }
      .modal-content .modal-btn{
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }

      /* í„°ì¹˜ ì˜ì—­ í™•ëŒ€ (í´ë¦­í•˜ê¸° ì‰½ê²Œ) */
      .pt{
        width: calc(var(--cell) * 1.2);
        height: calc(var(--cell) * 1.2);
      }

      /* ëŒ í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
      .stone{
        width: 21px;
        height: 21px;
      }
    }

    /* ì´ˆì†Œí˜• ëª¨ë°”ì¼ (ì•„ì´í° SE ë“±) */
    @media (max-width: 375px) {
      .topbar{
        font-size: 0.75rem;
      }
      .timer-container{
        gap: 15px;
        padding: 0.4rem 0.8rem;
      }
      .timer-value{
        font-size: 1rem;
      }
      .board-wrap{
        margin-top: 50px;
      }
      .modal-content{
        padding: 1rem 1.5rem;
      }
      .modal-content h2{
        font-size: 1.2rem;
      }
      .modal-content .winner-name{
        font-size: 1.5rem;
      }
      .stone{
        width: 22px;
        height: 22px;
      }
    }

    /* íƒœë¸”ë¦¿ ê°€ë¡œ ëª¨ë“œ */
    @media (min-width: 769px) and (max-width: 1024px) {
      .board-wrap{
        width: 600px;
        height: 600px;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>{{ game.title }}</div>
    <div id="ws-state">ê²Œì„ ì—°ê²° ì¤‘â€¦</div>

    <!-- í”Œë ˆì´ì–´ ì •ë³´ -->
    <div class="players">
      <div class="player-info">
        <span class="label">í‘(â—):</span>
        <span id="black-player">ëŒ€ê¸°ì¤‘...</span>
      </div>
      <div class="player-info">
        <span class="label">ë°±(â—‹):</span>
        <span id="white-player">ëŒ€ê¸°ì¤‘...</span>
      </div>
    </div>

    <!-- ì—¬ê¸°! ìƒë‹¨ ìš°ì¸¡ì— ìŠ¹ì ë°°ì§€ -->
    <div id="winnerTop" class="winner-badge"></div>

    <div class="right">
      <div id="turn"></div>
      <a href="{% url 'games:leave' pk=game.pk %}" class="pill" id="leave-btn" style="display:none; background:#888; border-color:#666;">ë‚˜ê°€ê¸°</a>
      <button class="pill" id="surrender-btn" style="display:none; background:#c44; border-color:#a33;">í•­ë³µ</button>
      <button class="pill" id="rematch-btn" style="display:none; background:#4a7c59; border-color:#3a6c49;">ë¦¬ë§¤ì¹˜ ìš”ì²­</button>
      <a href="{% url 'games:leave' pk=game.pk %}" class="pill" id="lobby-btn" style="display:none;">ë¡œë¹„ë¡œ ê°€ê¸°</a>
      <button class="pill" id="new-game-btn" disabled style="opacity:0.5; cursor:not-allowed;">ìƒˆ ê²Œì„</button>
    </div>
  </div>

  <!-- íƒ€ì´ë¨¸ (ìƒë‹¨ ì¤‘ì•™) -->
  <div class="timer-container" id="timerContainer" style="display:none;">
    <div class="timer-item">
      <div class="timer-label">í‘(â—)</div>
      <div class="timer-value black" id="blackTimer">15:00</div>
    </div>
    <div class="timer-item">
      <div class="timer-label">ë°±(â—‹)</div>
      <div class="timer-value white" id="whiteTimer">15:00</div>
    </div>
  </div>

  <div class="board-wrap" id="boardWrap">
    <svg id="grid" class="grid" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>
    <div class="layer" id="stones"></div>
    <div class="layer" id="points"></div>
  </div>

  <div class="status">
    <span id="winner" class="winner"></span>
  </div>

  <!-- ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ -->
  <div id="gameOverModal" class="game-over-modal">
    <div class="modal-content">
      <h2>ê²Œì„ ì¢…ë£Œ!</h2>
      <div class="winner-stone" id="modalStone"></div>
      <div class="winner-name" id="modalWinnerName"></div>
      <p style="font-size:1.1rem; color:#666;">ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
      <button class="modal-btn" onclick="closeModal()">í™•ì¸</button>
    </div>
  </div>

  <!-- ë¦¬ë§¤ì¹˜ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="rematchRequestModal" class="game-over-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">ë¦¬ë§¤ì¹˜ ìš”ì²­</h2>
      <div class="rematch-icon">
        <div class="circle-arrow"></div>
        <div class="circle-arrow"></div>
      </div>
      <p style="font-size:1.3rem; font-weight:700; margin:1rem 0;">ë¦¬ë§¤ì¹˜ ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤!</p>
      <p style="font-size:1.1rem; color:#666;">ì¬ê²½ê¸°ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div style="display:flex; gap:12px; margin-top:1.5rem;">
        <button class="modal-btn" onclick="acceptRematch()" style="background:#4a7c59; flex:1;">ìŠ¹ì¸</button>
        <button class="modal-btn" onclick="declineRematch()" style="background:#999; flex:1;">ê±°ì ˆ</button>
      </div>
    </div>
  </div>

  <!-- ì¬ê²½ê¸° ì¹´ìš´íŠ¸ë‹¤ìš´ ëª¨ë‹¬ -->
  <div id="countdownModal" class="game-over-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">ì¬ê²½ê¸° ì‹œì‘</h2>
      <div style="font-size:2rem; margin:1rem 0;">ì¬ê²½ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!</div>
      <div style="font-size:4rem; font-weight:900; color:#d84315; margin:1rem 0;" id="countdownNumber">3</div>
    </div>
  </div>

  <!-- ë¦¬ë§¤ì¹˜ ëŒ€ê¸° ëª¨ë‹¬ -->
  <div id="rematchWaitingModal" class="game-over-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">ë¦¬ë§¤ì¹˜ ìš”ì²­</h2>
      <div class="loading-spinner"></div>
      <p style="font-size:1.3rem; font-weight:700; margin:1rem 0;">
        ë¦¬ë§¤ì¹˜ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ëŠ”ì¤‘<span class="dots"></span>
      </p>
      <button class="modal-btn" onclick="cancelRematchRequest()" style="background:#999; margin-top:1rem;">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- í”Œë ˆì´ì–´ ì…ì¥ ëª¨ë‹¬ -->
  <div id="playerJoinedModal" class="game-over-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">í”Œë ˆì´ì–´ ì…ì¥!</h2>
      <div style="font-size:2.5rem; margin:1rem 0;">â—â—‹</div>
      <p style="font-size:1.3rem; font-weight:700; margin:1rem 0;" id="joinedPlayerName"></p>
      <p style="font-size:1.1rem; color:#666;">ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤!</p>
      <button class="modal-btn" onclick="closePlayerJoinedModal()" style="background:#4a7c59;">í™•ì¸</button>
    </div>
  </div>

  <!-- ì¤€ë¹„ ëª¨ë‹¬ -->
  <div id="readyModal" class="game-over-modal">
    <div class="modal-content">
      <h2 style="color:#4a7c59;">ê²Œì„ ì¤€ë¹„</h2>
      <div style="font-size:2rem; margin:1rem 0;">â—â—‹</div>

      <!-- ì¤€ë¹„ ìƒíƒœ í‘œì‹œ -->
      <div style="margin:1.5rem 0; font-size:1.1rem;">
        <div style="margin:0.5rem 0;">
          <span style="font-weight:700;">í‘(â—):</span>
          <span id="readyBlackStatus" style="margin-left:0.5rem; color:#999;">ì¤€ë¹„ ëŒ€ê¸°ì¤‘...</span>
        </div>
        <div style="margin:0.5rem 0;">
          <span style="font-weight:700;">ë°±(â—‹):</span>
          <span id="readyWhiteStatus" style="margin-left:0.5rem; color:#999;">ì¤€ë¹„ ëŒ€ê¸°ì¤‘...</span>
        </div>
      </div>

      <!-- ì¤€ë¹„ ì™„ë£Œ ë²„íŠ¼ -->
      <button id="readyBtn" class="modal-btn" style="background:#4a7c59; margin-top:1rem;" onclick="clickReady()">ì¤€ë¹„ ì™„ë£Œ</button>

      <!-- ê²Œì„ ì‹œì‘ ë²„íŠ¼ (ë°©ì¥ë§Œ, ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œ ì‹œ í‘œì‹œ) -->
      <button id="startGameBtn" class="modal-btn" style="background:#d84315; margin-top:0.5rem; display:none;" onclick="clickStartGame()">ê²Œì„ ì‹œì‘</button>
    </div>
  </div>

<script>
(function(){
  const SIZE   = {{ BOARD_SIZE }};
  const gameId = {{ game.id }};
  const scheme = (location.protocol === "https:") ? "wss" : "ws";
  const wsURL  = `${scheme}://${location.host}/ws/games/${gameId}/`;

  const gridEl       = document.getElementById("grid");
  const stonesEl     = document.getElementById("stones");
  const pointsEl     = document.getElementById("points");
  const wsState      = document.getElementById("ws-state");
  const turnEl       = document.getElementById("turn");
  const winnerEl     = document.getElementById("winner");     // í•˜ë‹¨(ë³´ì¡°)
  const winnerTop    = document.getElementById("winnerTop");  // ìƒë‹¨ ë°°ì§€
  const blackPlayer  = document.getElementById("black-player");
  const whitePlayer  = document.getElementById("white-player");
  const lobbyBtn     = document.getElementById("lobby-btn");
  const leaveBtn     = document.getElementById("leave-btn");
  const surrenderBtn = document.getElementById("surrender-btn");
  const rematchBtn   = document.getElementById("rematch-btn");
  const newGameBtn   = document.getElementById("new-game-btn");
  const gameOverModal = document.getElementById("gameOverModal");
  const modalStone    = document.getElementById("modalStone");
  const modalWinnerName = document.getElementById("modalWinnerName");
  const playerJoinedModal = document.getElementById("playerJoinedModal");
  const joinedPlayerName = document.getElementById("joinedPlayerName");
  const timerContainer = document.getElementById("timerContainer");
  const blackTimer    = document.getElementById("blackTimer");
  const whiteTimer    = document.getElementById("whiteTimer");
  const readyModal = document.getElementById("readyModal");
  const readyBlackStatus = document.getElementById("readyBlackStatus");
  const readyWhiteStatus = document.getElementById("readyWhiteStatus");
  const readyBtn = document.getElementById("readyBtn");
  const startGameBtn = document.getElementById("startGameBtn");

  /* ===== íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜ ===== */
  let currentTurn = null;
  let currentBlackTime = 900;
  let currentWhiteTime = 900;
  let timerInterval = null;

  /* ===== ì°©ìˆ˜ ì¤‘ë³µ ë°©ì§€ ===== */
  let isPlaying = false;

  // íƒ€ì´ë¨¸ í¬ë§·: ì´ˆ â†’ MM:SS
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateTimers() {
    if (!currentTurn || currentBlackTime <= 0 || currentWhiteTime <= 0) {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      return;
    }

    // í˜„ì¬ í„´ í”Œë ˆì´ì–´ì˜ ì‹œê°„ 1ì´ˆ ê°ì†Œ
    if (currentTurn === "black") {
      currentBlackTime = Math.max(0, currentBlackTime - 1);
      blackTimer.textContent = formatTime(currentBlackTime);
      // 30ì´ˆ ì´í•˜ë©´ ê²½ê³  í‘œì‹œ
      if (currentBlackTime <= 30) {
        blackTimer.classList.add("warning");
      } else {
        blackTimer.classList.remove("warning");
      }
    } else {
      currentWhiteTime = Math.max(0, currentWhiteTime - 1);
      whiteTimer.textContent = formatTime(currentWhiteTime);
      // 30ì´ˆ ì´í•˜ë©´ ê²½ê³  í‘œì‹œ
      if (currentWhiteTime <= 30) {
        whiteTimer.classList.add("warning");
      } else {
        whiteTimer.classList.remove("warning");
      }
    }
  }

  // íƒ€ì´ë¨¸ ì¸í„°ë²Œ ì‹œì‘
  function startTimerInterval() {
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    timerInterval = setInterval(updateTimers, 1000);
  }

  /* ===== ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ ===== */
  let modalShown = false;  // ëª¨ë‹¬ì´ ì´ë¯¸ í‘œì‹œë˜ì—ˆëŠ”ì§€ ì¶”ì 
  let isPracticeMode = false;  // ì—°ìŠµ ëª¨ë“œ ì—¬ë¶€

  const rematchRequestModal = document.getElementById("rematchRequestModal");
  const rematchWaitingModal = document.getElementById("rematchWaitingModal");
  const countdownModal = document.getElementById("countdownModal");
  const countdownNumber = document.getElementById("countdownNumber");

  window.closeModal = function() {
    gameOverModal.style.display = "none";
    modalShown = false;

    // ì—°ìŠµ ëª¨ë“œì´ë©´ ê²Œì„íŒ ë¦¬ì…‹
    if (isPracticeMode && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({type: "reset_practice"}));
    }
    // ëŒ€ì „ ëª¨ë“œì´ë©´ ê·¸ëƒ¥ ëª¨ë‹¬ë§Œ ë‹«ê³  ê²Œì„ë£¸ì— ë‚¨ìŒ (ë¦¬ë§¤ì¹˜ ë²„íŠ¼ í™œì„±í™”ë¨)
  };

  // ë¦¬ë§¤ì¹˜ ìš”ì²­ ìŠ¹ì¸ í•¨ìˆ˜
  window.acceptRematch = function() {
    if (ws.readyState !== WebSocket.OPEN) {
      alert("ê²Œì„ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì„œë²„ì— ë¦¬ë§¤ì¹˜ ìˆ˜ë½ ì „ì†¡
    ws.send(JSON.stringify({type: "accept_rematch"}));

    // ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°
    rematchRequestModal.style.display = "none";
  };

  // ë¦¬ë§¤ì¹˜ ìš”ì²­ ê±°ì ˆ í•¨ìˆ˜
  window.declineRematch = function() {
    if (ws.readyState !== WebSocket.OPEN) {
      alert("ê²Œì„ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì„œë²„ì— ë¦¬ë§¤ì¹˜ ê±°ì ˆ ì „ì†¡
    ws.send(JSON.stringify({type: "decline_rematch"}));

    // ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°
    rematchRequestModal.style.display = "none";

    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    alert("ë¦¬ë§¤ì¹˜ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
  };

  // ë¦¬ë§¤ì¹˜ ìš”ì²­ ì·¨ì†Œ í•¨ìˆ˜
  window.cancelRematchRequest = function() {
    if (ws.readyState !== WebSocket.OPEN) {
      alert("ê²Œì„ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì„œë²„ì— ë¦¬ë§¤ì¹˜ ì·¨ì†Œ ì „ì†¡ (declineê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
    ws.send(JSON.stringify({type: "decline_rematch"}));

    // ëŒ€ê¸° ëª¨ë‹¬ ë‹«ê¸°
    rematchWaitingModal.style.display = "none";

    // ë¦¬ë§¤ì¹˜ ë²„íŠ¼ ë¦¬ì…‹
    rematchBtn.textContent = "ë¦¬ë§¤ì¹˜ ìš”ì²­";
    rematchBtn.disabled = false;
    rematchBtn.style.opacity = "1";
    rematchBtn.style.cursor = "pointer";
  };

  // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í•¨ìˆ˜
  function startCountdown() {
    let count = 3;
    countdownNumber.textContent = count;
    countdownModal.style.display = "flex";

    const countInterval = setInterval(() => {
      count--;
      if (count > 0) {
        countdownNumber.textContent = count;
      } else {
        clearInterval(countInterval);
        countdownModal.style.display = "none";
        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì™„ë£Œ í›„ ì¤€ë¹„ ëª¨ë‹¬ í‘œì‹œ
        showReadyModal();
      }
    }, 1000);
  }

  /* ===== í”Œë ˆì´ì–´ ì…ì¥ ëª¨ë‹¬ ===== */
  window.closePlayerJoinedModal = function() {
    playerJoinedModal.style.display = "none";
    // ëª¨ë‹¬ ë‹«ì„ ë•Œë„ AudioContext í™œì„±í™”
    if (audioCtx && audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
    // í”Œë ˆì´ì–´ ì…ì¥ ëª¨ë‹¬ ë‹«ì€ í›„ ì¤€ë¹„ ëª¨ë‹¬ í‘œì‹œ
    showReadyModal();
  };

  /* ===== ì¤€ë¹„ ëª¨ë‹¬ ===== */
  let isRoomCreator = false;  // í˜„ì¬ ìœ ì €ê°€ ë°©ì¥(í‘)ì¸ì§€ ì—¬ë¶€

  function showReadyModal() {
    // ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
    if (readyModal.style.display === "flex") return;

    readyModalShown = true;  // í”Œë˜ê·¸ ì„¤ì •
    readyModal.style.display = "flex";
    // ì´ˆê¸° ìƒíƒœ: ëª¨ë‘ ì¤€ë¹„ ëŒ€ê¸°ì¤‘
    readyBlackStatus.textContent = "ì¤€ë¹„ ëŒ€ê¸°ì¤‘...";
    readyBlackStatus.style.color = "#999";
    readyWhiteStatus.textContent = "ì¤€ë¹„ ëŒ€ê¸°ì¤‘...";
    readyWhiteStatus.style.color = "#999";
    // ì¤€ë¹„ ë²„íŠ¼ í‘œì‹œ, ê²Œì„ ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€
    readyBtn.style.display = "inline-block";
    startGameBtn.style.display = "none";
  }

  window.clickReady = function() {
    if (ws.readyState !== WebSocket.OPEN) {
      alert("ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    // ì¤€ë¹„ ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
    ws.send(JSON.stringify({type: "player_ready"}));
    // ìì‹ ì˜ ì¤€ë¹„ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    readyBtn.disabled = true;
    readyBtn.style.opacity = "0.5";
    readyBtn.style.cursor = "not-allowed";
  };

  window.clickStartGame = function() {
    if (ws.readyState !== WebSocket.OPEN) {
      alert("ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    // ê²Œì„ ì‹œì‘ ë©”ì‹œì§€ ì „ì†¡
    ws.send(JSON.stringify({type: "start_game"}));
  };

  function handleReadyState(data) {
    // ì¤€ë¹„ ìƒíƒœ ì—…ë°ì´íŠ¸
    if (data.black_ready) {
      readyBlackStatus.textContent = "ì¤€ë¹„ ì™„ë£Œ!";
      readyBlackStatus.style.color = "#4a7c59";
      readyBlackStatus.style.fontWeight = "700";
    } else {
      readyBlackStatus.textContent = "ì¤€ë¹„ ëŒ€ê¸°ì¤‘...";
      readyBlackStatus.style.color = "#999";
    }

    if (data.white_ready) {
      readyWhiteStatus.textContent = "ì¤€ë¹„ ì™„ë£Œ!";
      readyWhiteStatus.style.color = "#4a7c59";
      readyWhiteStatus.style.fontWeight = "700";
    } else {
      readyWhiteStatus.textContent = "ì¤€ë¹„ ëŒ€ê¸°ì¤‘...";
      readyWhiteStatus.style.color = "#999";
    }

    // ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œ && ë°©ì¥ì´ë©´ ê²Œì„ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
    if (data.black_ready && data.white_ready && data.is_room_creator) {
      startGameBtn.style.display = "inline-block";
    }
  }

  function handleGameStart() {
    // ì¤€ë¹„ ëª¨ë‹¬ ë‹«ê¸°
    readyModal.style.display = "none";
    // ì¤€ë¹„ ë²„íŠ¼ ë¦¬ì…‹ (ë‹¤ìŒ ê²Œì„ì„ ìœ„í•´)
    readyBtn.disabled = false;
    readyBtn.style.opacity = "1";
    readyBtn.style.cursor = "pointer";
  }

  function handleRematchState(data) {
    // ì–‘ìª½ ëª¨ë‘ ë¦¬ë§¤ì¹˜ ìˆ˜ë½í•˜ë©´ ê²Œì„ ë¦¬ì…‹
    if (data.game_reset) {
      // ê²Œì„íŒ ë¦¬ì…‹ë˜ì—ˆìœ¼ë‹ˆ ëª¨ë‹¬ ë¦¬ì…‹í•˜ê³  ì¤€ë¹„ ëª¨ë‹¬ í‘œì‹œ
      modalShown = false;
      readyModalShown = false;
      gameOverModal.style.display = "none";

      // ë¦¬ë§¤ì¹˜ ë²„íŠ¼ ë¦¬ì…‹
      rematchBtn.textContent = "ë¦¬ë§¤ì¹˜ ìš”ì²­";
      rematchBtn.disabled = false;
      rematchBtn.style.opacity = "1";
      rematchBtn.style.cursor = "pointer";
      rematchBtn.style.display = "none";

      // ì¤€ë¹„ ëª¨ë‹¬ í‘œì‹œ
      showReadyModal();
    } else {
      // í•œìª½ë§Œ ìš”ì²­í•œ ìƒíƒœ: ìƒëŒ€ë°©ì´ ìˆ˜ë½í•˜ë©´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      if (data.rematch_black && data.rematch_white) {
        // ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬
      } else if (data.rematch_black || data.rematch_white) {
        // í•œìª½ë§Œ ìš”ì²­í•œ ìƒíƒœ
        if (rematchBtn.textContent !== "ìš”ì²­ë¨...") {
          // ìƒëŒ€ë°©ì´ ìš”ì²­í•œ ê²½ìš°
          rematchBtn.textContent = "ìƒëŒ€ë°©ì´ ìš”ì²­í•¨";
        }
      }
    }
  }

  function showPlayerJoinedModal(playerName) {
    joinedPlayerName.textContent = playerName + " ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤!";
    playerJoinedModal.style.display = "flex";
    // ì…ì¥ìŒ ì¬ìƒ
    playStoneSound();
  }

  function showGameOverModal(winner, winnerName, isSoloPlay) {
    if (modalShown) return;  // ì´ë¯¸ í‘œì‹œë˜ì—ˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€

    modalShown = true;
    modalStone.textContent = winner === "black" ? "â—" : "â—‹";
    modalWinnerName.textContent = winnerName || (winner === "black" ? "í‘" : "ë°±");

    // í˜¼ì í”Œë ˆì´ë©´ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ê²Œì„íŒ ë¦¬ì…‹
    if (isSoloPlay) {
      // ëª¨ë‹¬ì€ í‘œì‹œí•˜ì§€ ì•Šê³ , 3ì´ˆ í›„ ìë™ ë¦¬ì…‹
      setTimeout(() => {
        resetGameForPractice();
      }, 3000);
    } else {
      // ìƒëŒ€ë°©ê³¼ í”Œë ˆì´: ëª¨ë‹¬ í‘œì‹œ
      gameOverModal.style.display = "flex";
    }
  }

  // ì—°ìŠµìš© ê²Œì„íŒ ë¦¬ì…‹ í•¨ìˆ˜
  function resetGameForPractice() {
    // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
    modalShown = false;
    prevStoneCount = 0;

    // ì„œë²„ì— ë¦¬ì…‹ ìš”ì²­ ì „ì†¡
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({type: "reset_practice"}));
    }

    // ë¹ˆ ê²Œì„íŒìœ¼ë¡œ ë Œë”ë§ (ì„œë²„ì—ì„œ broadcast_stateë¡œ ë‹¤ì‹œ ë°›ê² ì§€ë§Œ, ì¦‰ê°ì ì¸ UI ë°˜ì‘ì„ ìœ„í•´)
    const emptyBoard = ".".repeat(SIZE * SIZE);
    render({
      board: emptyBoard,
      turn: "black",
      winner: null,
      black_player: blackPlayer.textContent,
      white_player: null
    });
  }

  /* ===== íš¨ê³¼ìŒ ===== */
  let prevStoneCount = 0;  // ì´ì „ ëŒ ê°œìˆ˜ ì¶”ì 
  let audioCtx = null;  // AudioContextë¥¼ ì¬ì‚¬ìš©
  let lastPlayTime = 0;  // ë§ˆì§€ë§‰ ì¬ìƒ ì‹œê°„

  function initAudio() {
    if (!audioCtx) {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch(e) {
        console.error('AudioContext ìƒì„± ì‹¤íŒ¨:', e);
      }
    }

    // AudioContextê°€ ìˆìœ¼ë©´ í•­ìƒ resume ì‹œë„
    if (audioCtx && audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  // ì‹¤ì œ ì¬ìƒ í•¨ìˆ˜ ë¨¼ì € ì„ ì–¸ (í˜¸ì´ìŠ¤íŒ… ì´ìŠˆ ë°©ì§€)
  function actuallyPlaySound() {
    try {
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended' || audioCtx.state === 'closed') return;

      lastPlayTime = Date.now();

      // ë§¤ë²ˆ ìƒˆë¡œìš´ ë²„í¼ ìƒì„±
      const bufferSize = audioCtx.sampleRate * 0.05; // 50ms
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);

      // í™”ì´íŠ¸ ë…¸ì´ì¦ˆ ìƒì„±
      for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.15));
      }

      // ë²„í¼ ì†ŒìŠ¤ ìƒì„±
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;

      // í•„í„°ë¡œ ë†’ì€ ì£¼íŒŒìˆ˜ ê°•ì¡° (ë‚ ì¹´ë¡œìš´ "ë”±" ì†Œë¦¬)
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 1000;

      const gainNode = audioCtx.createGain();
      gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);

      noise.connect(filter);
      filter.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      noise.start(audioCtx.currentTime);
      noise.stop(audioCtx.currentTime + 0.05);
    } catch(e) {
      console.error('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', e);
    }
  }

  function playStoneSound(){
    try {
      // AudioContextê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
      if (!audioCtx) {
        initAudio();
      }

      if (!audioCtx) return;

      // suspended ìƒíƒœë©´ resume í›„ ì¬ìƒ
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          actuallyPlaySound();
        });
        return;
      }

      // running ìƒíƒœë©´ ë°”ë¡œ ì¬ìƒ
      actuallyPlaySound();
    } catch(e) {
      console.error('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', e);
    }
  }

  // í”Œë ˆì´ì–´ ì…ì¥ ë²¨ ì†Œë¦¬ ("ë ë§~")
  function playJoinBellSound() {
    try {
      if (!audioCtx) {
        initAudio();
      }

      if (!audioCtx) return;

      // suspended ìƒíƒœë©´ resume í›„ ì¬ìƒ
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          actuallyPlayBell();
        });
        return;
      }

      actuallyPlayBell();
    } catch(e) {
      console.error('ë²¨ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', e);
    }
  }

  function actuallyPlayBell() {
    try {
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended' || audioCtx.state === 'closed') return;

      const now = audioCtx.currentTime;

      // ì²« ë²ˆì§¸ ìŒ (ë†’ì€ "ë ")
      const osc1 = audioCtx.createOscillator();
      osc1.type = 'sine';
      osc1.frequency.setValueAtTime(800, now);  // ë†’ì€ ìŒ

      const gain1 = audioCtx.createGain();
      gain1.gain.setValueAtTime(0.3, now);
      gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

      osc1.connect(gain1);
      gain1.connect(audioCtx.destination);

      osc1.start(now);
      osc1.stop(now + 0.3);

      // ë‘ ë²ˆì§¸ ìŒ (ë‚®ì€ "ë§~")
      const osc2 = audioCtx.createOscillator();
      osc2.type = 'sine';
      osc2.frequency.setValueAtTime(600, now + 0.15);  // ë‚®ì€ ìŒ

      const gain2 = audioCtx.createGain();
      gain2.gain.setValueAtTime(0.3, now + 0.15);
      gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

      osc2.connect(gain2);
      gain2.connect(audioCtx.destination);

      osc2.start(now + 0.15);
      osc2.stop(now + 0.5);
    } catch(e) {
      console.error('ë²¨ ì†Œë¦¬ ìƒì„± ì‹¤íŒ¨:', e);
    }
  }

  // ì‚¬ìš©ìê°€ í˜ì´ì§€ì™€ ìƒí˜¸ì‘ìš©í•˜ë©´ AudioContext ì´ˆê¸°í™” (ë¸Œë¼ìš°ì € ì •ì±… ëŒ€ì‘)
  document.addEventListener('click', initAudio, { once: true });

  // í´ë¦­í•  ë•Œë§ˆë‹¤ AudioContext resume ì‹œë„ (suspend ë°©ì§€)
  document.addEventListener('click', () => {
    if (audioCtx && audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  });

  /* ===== ì¢Œí‘œ/ê²©ì ===== */
  const MARGIN_PCT = 8;
  const innerMin   = MARGIN_PCT;
  const innerMax   = 100 - MARGIN_PCT;
  const step       = (innerMax - innerMin) / (SIZE - 1);

  function starPoints(size){
    if (size === 15) return [[4,4],[4,12],[8,8],[12,4],[12,12]];
    if (size === 19) return [[4,4],[4,10],[4,16],[10,4],[10,10],[10,16],[16,4],[16,10],[16,16]];
    if (size === 13) return [[4,4],[4,10],[7,7],[10,4],[10,10]];
    if (size % 2 === 1) { const mid = (size + 1) / 2; return [[mid, mid]]; }
    return [];
  }

  function drawGrid(){
    let g = "";
    g += `<rect x="0" y="0" width="100" height="100" fill="var(--wood)"/>`;
    g += `<rect x="1.2" y="1.2" width="97.6" height="97.6" fill="none"
               stroke="var(--border)" stroke-width="2.4" rx="2" ry="2"/>`;
    for (let i=0;i<SIZE;i++){
      const p = innerMin + i*step;
      g += `<line x1="${innerMin}" y1="${p}" x2="${innerMax}" y2="${p}"
                  stroke="var(--line)" stroke-width="0.6" />`;
      g += `<line x1="${p}" y1="${innerMin}" x2="${p}" y2="${innerMax}"
                  stroke="var(--line)" stroke-width="0.6" />`;
    }
    for (const [gx,gy] of starPoints(SIZE)){
      const cx = innerMin + (gx-1)*step;
      const cy = innerMin + (gy-1)*step;
      g += `<circle cx="${cx}" cy="${cy}" r="1.3" fill="#6e5239" opacity="0.9"/>`;
    }
    gridEl.innerHTML = g;
  }
  drawGrid();

  /* ===== í´ë¦­ í¬ì¸íŠ¸ ===== */
  const pts = [];
  for (let y=0;y<SIZE;y++){
    for (let x=0;x<SIZE;x++){
      const px = innerMin + x*step;
      const py = innerMin + y*step;
      const btn = document.createElement("button");
      btn.className = "pt";
      btn.style.left = px + "%";
      btn.style.top  = py + "%";
      btn.dataset.x = x;
      btn.dataset.y = y;
      btn.addEventListener("click", onPlay);
      pointsEl.appendChild(btn);
      pts.push(btn);
    }
  }

  /* ===== WebSocket ===== */
  const ws = new WebSocket(wsURL);
  ws.addEventListener("open",  ()=> wsState.textContent = "");
  ws.addEventListener("close", e => wsState.textContent = "ì—°ê²° ëŠê¹€");
  ws.addEventListener("error", ()=> wsState.textContent = "ì—°ê²° ì˜¤ë¥˜");
  ws.addEventListener("message", (e)=>{
    const m = JSON.parse(e.data);
    if (m.type === "state") {
      render(m);
    } else if (m.type === "player_joined") {
      // í”Œë ˆì´ì–´ ì…ì¥ ëª¨ë‹¬ í‘œì‹œ
      const playerName = m.white_player || "ìƒëŒ€ë°©";
      showPlayerJoinedModal(playerName);
      // ì…ì¥ ë²¨ ì†Œë¦¬ ì¬ìƒ ("ë ë§~")
      playJoinBellSound();
      // ì´ˆê¸°í™”ëœ ìƒíƒœë¡œ ë Œë”ë§
      render(m);
      // ëŒ ì¹´ìš´íŠ¸ë„ ë¦¬ì…‹
      prevStoneCount = 0;
      // ì…ì¥ ëª¨ë‹¬ì„ ìë™ìœ¼ë¡œ 3ì´ˆ í›„ ë‹«ê³  ì¤€ë¹„ ëª¨ë‹¬ í‘œì‹œ
      setTimeout(() => {
        if (playerJoinedModal.style.display === "flex") {
          closePlayerJoinedModal();
        }
      }, 3000);
    } else if (m.type === "ready_state") {
      // ì¤€ë¹„ ìƒíƒœ ì—…ë°ì´íŠ¸
      handleReadyState(m);
    } else if (m.type === "game_start") {
      // ê²Œì„ ì‹œì‘
      handleGameStart();
      // ê²Œì„ ìƒíƒœ ë Œë”ë§
      render(m);
    } else if (m.type === "error") {
      // ì°©ìˆ˜ ì—ëŸ¬ ë°œìƒ ì‹œ í”Œë˜ê·¸ í•´ì œ (ë‹¤ìŒ ì°©ìˆ˜ ê°€ëŠ¥í•˜ë„ë¡)
      isPlaying = false;
      alert(m.message);
    } else if (m.type === "game_deleted") {
      // ê²Œì„ì´ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ë¡œë¹„ë¡œ ì´ë™
      alert("ë°© ìƒì„±ìê°€ ë‚˜ê°€ì„œ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = "{% url 'games:lobby' %}";
    } else if (m.type === "rematch_state") {
      // ë¦¬ë§¤ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸
      handleRematchState(m);
    } else if (m.type === "rematch_request") {
      // ìƒëŒ€ë°©ìœ¼ë¡œë¶€í„° ë¦¬ë§¤ì¹˜ ìš”ì²­ì´ ì™”ì„ ë•Œ ëŒ€ê¸° ëª¨ë‹¬ ìˆ¨ê¸°ê³  ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ
      rematchWaitingModal.style.display = "none";
      rematchRequestModal.style.display = "flex";
    } else if (m.type === "rematch_accepted") {
      // ì–‘ìª½ ëª¨ë‘ ë¦¬ë§¤ì¹˜ë¥¼ ìˆ˜ë½í–ˆì„ ë•Œ ëŒ€ê¸° ëª¨ë‹¬ ìˆ¨ê¸°ê³  ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
      rematchWaitingModal.style.display = "none";
      startCountdown();
    } else if (m.type === "rematch_declined") {
      // ìƒëŒ€ë°©ì´ ë¦¬ë§¤ì¹˜ë¥¼ ê±°ì ˆí–ˆì„ ë•Œ
      // ëŒ€ê¸° ëª¨ë‹¬ì´ í‘œì‹œë˜ì–´ ìˆì—ˆìœ¼ë©´ ìš”ì²­ìì´ë¯€ë¡œ ì•Œë¦¼ í‘œì‹œ
      if (rematchWaitingModal.style.display === "flex") {
        rematchWaitingModal.style.display = "none";
        alert("ìƒëŒ€ë°©ì´ ë¦¬ë§¤ì¹˜ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
      }
      // ë¦¬ë§¤ì¹˜ ë²„íŠ¼ ë¦¬ì…‹
      rematchBtn.textContent = "ë¦¬ë§¤ì¹˜ ìš”ì²­";
      rematchBtn.disabled = false;
      rematchBtn.style.opacity = "1";
      rematchBtn.style.cursor = "pointer";
    }
  });

  function onPlay(e){
    if (ws.readyState !== WebSocket.OPEN){
      alert("ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;
    }
    // ì°©ìˆ˜ ì¤‘ì´ë©´ ë¬´ì‹œ (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    if (isPlaying) return;

    const x = +e.currentTarget.dataset.x;
    const y = +e.currentTarget.dataset.y;

    // ì°©ìˆ˜ ì¤‘ í”Œë˜ê·¸ ì„¤ì •
    isPlaying = true;

    ws.send(JSON.stringify({type:"play", x, y}));
  }

  /* ===== í•­ë³µ ë²„íŠ¼ ===== */
  surrenderBtn.addEventListener("click", ()=>{
    if (ws.readyState !== WebSocket.OPEN){
      alert("ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;
    }
    if (confirm("ì •ë§ í•­ë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      ws.send(JSON.stringify({type:"surrender"}));
    }
  });

  /* ===== ë¦¬ë§¤ì¹˜ ë²„íŠ¼ ===== */
  rematchBtn.addEventListener("click", ()=>{
    if (ws.readyState !== WebSocket.OPEN){
      alert("ê²Œì„ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;
    }
    ws.send(JSON.stringify({type:"request_rematch"}));
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ë¹„í™œì„±í™”
    rematchBtn.textContent = "ìš”ì²­ë¨...";
    rematchBtn.disabled = true;
    rematchBtn.style.opacity = "0.5";
    rematchBtn.style.cursor = "not-allowed";

    // ëŒ€ê¸° ëª¨ë‹¬ í‘œì‹œ
    rematchWaitingModal.style.display = "flex";
  });

  /* ===== ìƒˆ ê²Œì„ ë²„íŠ¼ ===== */
  newGameBtn.addEventListener("click", ()=>{
    if (!newGameBtn.disabled) {
      window.location.href = "{% url 'games:new' %}";
    }
  });

  /* ===== ë Œë” ===== */
  let readyModalShown = false;  // ì¤€ë¹„ ëª¨ë‹¬ì´ ì´ë¯¸ í‘œì‹œë˜ì—ˆëŠ”ì§€ ì¶”ì 
  let prevBoard = "";  // ì´ì „ ë³´ë“œ ìƒíƒœ (ë§ˆì§€ë§‰ ì°©ìˆ˜ ì°¾ê¸°ìš©)
  let lastStoneIndex = -1;  // ë§ˆì§€ë§‰ ì°©ìˆ˜ ìœ„ì¹˜ (ì „ì—­ìœ¼ë¡œ ê´€ë¦¬)

  function render(state){
    const { board, turn, winner, black_player, white_player, black_time, white_time } = state;

    // ì°©ìˆ˜ ì™„ë£Œ, í”Œë˜ê·¸ í•´ì œ
    isPlaying = false;

    // ì—°ìŠµ ëª¨ë“œ ê°ì§€ (ì–‘ìª½ í”Œë ˆì´ì–´ê°€ ëª¨ë‘ ì—†ìœ¼ë©´ ì—°ìŠµ ëª¨ë“œ)
    isPracticeMode = !black_player || !white_player;

    // í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸
    blackPlayer.textContent = black_player || "ëŒ€ê¸°ì¤‘...";
    whitePlayer.textContent = white_player || "ëŒ€ê¸°ì¤‘...";

    // ëŒ ë Œë”
    stonesEl.innerHTML = "";
    let currentStoneCount = 0;

    // ë§ˆì§€ë§‰ ì°©ìˆ˜ ìœ„ì¹˜ ì°¾ê¸° (ìƒˆë¡œìš´ ëŒì´ ì¶”ê°€ë˜ì—ˆì„ ë•Œë§Œ)
    if (prevBoard && prevBoard.length === board.length) {
      for (let i = 0; i < board.length; i++) {
        if (prevBoard[i] === "." && board[i] !== ".") {
          lastStoneIndex = i;  // ìƒˆë¡œ ì¶”ê°€ëœ ëŒì˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        }
      }
    }

    for (let i=0;i<board.length;i++){
      const cell = board[i];
      if (cell === ".") continue;
      currentStoneCount++;
      const x = i % SIZE;
      const y = Math.floor(i / SIZE);
      const px = innerMin + x*step;
      const py = innerMin + y*step;
      const d = document.createElement("div");
      d.className = "stone " + (cell==="B" ? "black" : "white");

      // ë§ˆì§€ë§‰ ì°©ìˆ˜ëœ ëŒì´ë©´ í•­ìƒ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
      if (i === lastStoneIndex) {
        d.className += " last-move";
      }

      d.style.left = px + "%";
      d.style.top  = py + "%";
      stonesEl.appendChild(d);
    }

    // ìƒˆë¡œìš´ ëŒì´ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ íš¨ê³¼ìŒ ì¬ìƒ
    if (currentStoneCount > prevStoneCount) {
      playStoneSound();
    }
    prevStoneCount = currentStoneCount;

    // ì–‘ìª½ í”Œë ˆì´ì–´ê°€ ëª¨ë‘ ìˆê³ , ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ê³ , ì¤€ë¹„ ëª¨ë‹¬ì„ ì•„ì§ ì•ˆ ë´¤ìœ¼ë©´ í‘œì‹œ
    if (black_player && white_player && currentStoneCount === 0 && !readyModalShown && !winner) {
      readyModalShown = true;
      showReadyModal();
    }

    // ìƒë‹¨ ìŠ¹ì ë°°ì§€ & í„´ & ë‚˜ê°€ê¸°/í•­ë³µ ë²„íŠ¼ & ë¡œë¹„ ë²„íŠ¼ & ìƒˆ ê²Œì„ ë²„íŠ¼ & ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬
    if (winner){
      const text = `ìŠ¹ì: ${winner==="black" ? "í‘(â—)" : "ë°±(â—‹)"}`;
      winnerTop.textContent = text;
      winnerTop.style.display = "inline-block";
      turnEl.textContent = "";
      // ë‚˜ê°€ê¸°/í•­ë³µ ë²„íŠ¼ ìˆ¨ê¹€
      leaveBtn.style.display = "none";
      surrenderBtn.style.display = "none";
      // ë¦¬ë§¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ëŒ€ì „ ëª¨ë“œì¼ ë•Œë§Œ)
      if (!isPracticeMode) {
        rematchBtn.style.display = "inline-block";
      } else {
        rematchBtn.style.display = "none";
      }
      // ë¡œë¹„ë¡œ ê°€ê¸° ë²„íŠ¼ í‘œì‹œ
      lobbyBtn.style.display = "inline-block";
      // ìƒˆ ê²Œì„ ë²„íŠ¼ í™œì„±í™”
      newGameBtn.disabled = false;
      newGameBtn.style.opacity = "1";
      newGameBtn.style.cursor = "pointer";
      // í•˜ë‹¨ í‘œì‹œëŠ” ìˆ¨ê¹€
      winnerEl.textContent = "";
      winnerEl.style.display = "none";

      // ğŸ‰ ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ í‘œì‹œ (ìŠ¹ì ë‹‰ë„¤ì„ê³¼ í•¨ê»˜)
      const winnerName = winner === "black" ? black_player : white_player;
      // í˜¼ì í”Œë ˆì´ì¸ì§€ í™•ì¸ (ë°± í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ í˜¼ì)
      const isSoloPlay = !white_player || white_player === "ëŒ€ê¸°ì¤‘...";
      showGameOverModal(winner, winnerName, isSoloPlay);
    }else{
      winnerTop.style.display = "none";
      turnEl.textContent = `í„´: ${turn==="black" ? "í‘(â—)" : "ë°±(â—‹)"}`;

      // ê²Œì„ ì§„í–‰ ì¤‘: ì–‘ìª½ í”Œë ˆì´ì–´ê°€ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
      if (black_player && white_player) {
        // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ëŒì´ í•˜ë‚˜ë¼ë„ ë†“ì˜€ëŠ”ì§€)
        if (currentStoneCount > 0) {
          // ê²Œì„ ì‹œì‘ë¨: í•­ë³µ ë²„íŠ¼ë§Œ í‘œì‹œ
          leaveBtn.style.display = "none";
          surrenderBtn.style.display = "inline-block";
        } else {
          // ê²Œì„ ì‹œì‘ ì „: ë‚˜ê°€ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ
          leaveBtn.style.display = "inline-block";
          surrenderBtn.style.display = "none";
        }
        // ëŒ€ì „ ëª¨ë“œì—ì„œëŠ” ë¡œë¹„ ë²„íŠ¼ ìˆ¨ê¹€
        lobbyBtn.style.display = "none";
      } else {
        // í•œìª½ í”Œë ˆì´ì–´ë§Œ ìˆìœ¼ë©´ (ì—°ìŠµ ëª¨ë“œ) ë‚˜ê°€ê¸° ë²„íŠ¼ í‘œì‹œ (ë°© ì‚­ì œë¨)
        leaveBtn.style.display = "inline-block";
        surrenderBtn.style.display = "none";
        lobbyBtn.style.display = "none";
      }

      // ê²Œì„ ì§„í–‰ ì¤‘ì´ë©´ ë¦¬ë§¤ì¹˜ ë²„íŠ¼ ìˆ¨ê¹€
      rematchBtn.style.display = "none";

      // ê²Œì„ ì§„í–‰ ì¤‘ì´ë©´ ìƒˆ ê²Œì„ ë²„íŠ¼ ë¹„í™œì„±í™”
      newGameBtn.disabled = true;
      newGameBtn.style.opacity = "0.5";
      newGameBtn.style.cursor = "not-allowed";
    }

    // ë¹ˆ ì¹¸ë§Œ í´ë¦­ ê°€ëŠ¥
    for (let i=0;i<pts.length;i++){
      pts[i].disabled = (board[i] !== ".");
    }

    // ===== íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ =====
    // ì–‘ìª½ í”Œë ˆì´ì–´ê°€ ëª¨ë‘ ìˆê³ , íƒ€ì´ë¨¸ ì •ë³´ê°€ ìˆìœ¼ë©´ íƒ€ì´ë¨¸ í‘œì‹œ
    if (black_player && white_player && black_time !== undefined && white_time !== undefined) {
      // íƒ€ì´ë¨¸ ì •ë³´ ì—…ë°ì´íŠ¸
      currentBlackTime = black_time || 0;
      currentWhiteTime = white_time || 0;
      currentTurn = turn;

      // íƒ€ì´ë¨¸ í‘œì‹œ
      blackTimer.textContent = formatTime(currentBlackTime);
      whiteTimer.textContent = formatTime(currentWhiteTime);

      // 30ì´ˆ ì´í•˜ë©´ ê²½ê³  í‘œì‹œ
      if (currentBlackTime <= 30) {
        blackTimer.classList.add("warning");
      } else {
        blackTimer.classList.remove("warning");
      }
      if (currentWhiteTime <= 30) {
        whiteTimer.classList.add("warning");
      } else {
        whiteTimer.classList.remove("warning");
      }

      // í˜„ì¬ í„´ í”Œë ˆì´ì–´ì—ê²Œ active í´ë˜ìŠ¤ ì¶”ê°€
      if (turn === "black") {
        blackTimer.classList.add("active");
        whiteTimer.classList.remove("active");
      } else {
        whiteTimer.classList.add("active");
        blackTimer.classList.remove("active");
      }

      // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ê³  ìŠ¹ìê°€ ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ í‘œì‹œ ë° ì¸í„°ë²Œ ì‹œì‘
      if (!winner && currentStoneCount > 0) {
        timerContainer.style.display = "flex";
        startTimerInterval();
      } else {
        // ê²Œì„ì´ ëë‚¬ìœ¼ë©´ íƒ€ì´ë¨¸ ì¸í„°ë²Œ ì¤‘ì§€
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        // ê²Œì„ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ìˆ¨ê¹€
        if (winner) {
          timerContainer.style.display = "none";
          blackTimer.classList.remove("active");
          whiteTimer.classList.remove("active");
        }
      }
    } else {
      // í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ ìˆ¨ê¹€
      timerContainer.style.display = "none";
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // í˜„ì¬ ë³´ë“œ ìƒíƒœë¥¼ ì €ì¥ (ë‹¤ìŒ render ì‹œ ë§ˆì§€ë§‰ ì°©ìˆ˜ ì°¾ê¸°ìš©)
    prevBoard = board;
  }
})();
</script>
</body>
</html>